---
ssot: true
version: 1.0.0-rc.2
build_date: 2025-09-10
sources:
  - SmartAlloc_PDI_Master_Addendum_2025-09-10.md
  - سند نهایی تجمیع_شده (به_روزرسانی 2025-09-07)_PGFIX.md
  - smart_alloc_سند_اجرایی_کامل_افزونه_تخصیص_خودکار_v_1_UPDATED_2025-09-07.md
schemas:
  gf_form:
    canonical_form_id: 150
    canonical_version: 2.2   # from gf_form_import_SmartAlloc_v2.2.json
    next_target_version: 2.8 # NEXT: align generator+import to 2.8
  exporter_config:
    canonical_version: 1.0
    excel_template: "ImportToSabt (1404).xlsx"
  action_scheduler:
    group: "smartalloc"
    backoff_policy: "adapter-default" # NEXT: 1m,5m,15m,30m + jitter(10–20%)
quality_gates:
  patch_guard:
    file_cap: 20
    loc_cap: 800
  coverage_min: 0.80
  phpcs: strict
  site_health: all_green
  utc_everywhere: true
roles:
  capability: "manage_smartalloc"
  nonce: true
orchestration:
  style: "Senior PM, Baseline-Oriented"
  outputs: [Leadership Pulse, Baseline Achievement Matrix, Weekly Priorities, Blockers/Next Steps]
  handoff:
    required_if_not_ready: true
    files: [HANDOFF_PACKET.json, handoff_prompt_claude.md]
---
# SmartAlloc — Unified Manual (SSOT)

> این سند، منبع حقیقت واحد برای ادامهٔ کار SmartAlloc است. سیاست‌ها، حدود کیفی، و رویه‌های عملیاتی در اینجا «قفل» می‌شوند؛ ضمیمهٔ PDI «Append‑Only» است و با هر اجرا/انتشار به‌روز می‌گردد.

---

## Leadership Pulse
- **Phase:** Foundation → Expansion (در حال گذار)
- **Trajectory:** Async روی **Action Scheduler (گروه: `smartalloc`)**؛ فرم مرجع **GF v2.2** (NEXT: 2.8)؛ صادرکننده هم‌راستا با **Exporter Config v1.0**؛ UTC سرتاسری.
- **Hotspots:** Backoff مرکزی (NEXT)، تکمیل تست‌های منفی RuleEngine ترکیبی، سیم‌کشی نهایی Site Health، ارتقای ژنراتور GF به 2.8.
- **Go/No-Go:** Patch Guard PASS، Coverage ≥80%، Site Health سبز، آرتیفکت‌های PDI کامل.

---

## Baseline Achievement Matrix
| محور | وضعیت فعلی | آستانه/هدف | خروجی قابل اندازه‌گیری |
|---|---|---|---|
| **Async (AS)** | گروه واحد `smartalloc`، Adapter فعال | Backoff مرکزی (NEXT) | صف‌ها بدون Drift، DLQ ≤ 1% از کل |
| **GF Pipeline** | Hook اختصاصی فرم 150 + Idempotency | Rule‑of‑One enforced | Zero duplicate submissions |
| **Exporter** | Config v1.0 هم‌راستا؛ Streaming/Formula‑Safe | p95 ≤ 2s @ N≈1000 | گزارش Perf در PDI |
| **UTC** | Helper/Storage UTC | صفر مورد non‑UTC در core | UTC Audit=PASS |
| **Health** | کارت‌ها حاضر؛ Wiring نهایی | Site Health سبز | 0 Critical |
| **Security** | Capability + Nonce everywhere | PHPCS Strict | 0 High/Med |
| **Testing** | UT/IT اجرا؛ برخی Composite pending | Coverage ≥ 80% | TestDox + Failures.json |

---

## Weekly Priorities
1. **Backoff Policy (AS):** تعریف 1→5→15→30m با Jitter و ثبت در Adapter.
2. **RuleEngine Composite:** اتمام `evaluateComposite` + تست‌های منفی (Invalid op, Too‑deep, Empty set).
3. **Site Health Wiring:** ثبت تست‌ها با `site_status_tests` و KPIهای Queue/DLQ.
4. **GF Generator v2.8:** ارتقا و هم‌نسخه‌سازی متادیتا با هدف 2.8.
5. **Exporter Perf Bench:** اندازه‌گیری p95 و ثبت نتایج در PDI.

---

## Blockers / Next Steps
- **Mismatch ژنراتور GF ↔ هدف 2.8** (رفع در Sprint جاری).
- **تعریف نهایی Backoff مرکزی و حدود Retry → DLQ**.

---

## Ops Plane (Runbook)
### Release
1. **Pre‑flight:** Patch Guard PASS، Coverage ≥80%، Site Health Green.
2. **Canary:** 5% ترافیک Export/Notify؛ رصد DLQ/KPI.
3. **Rollout:** 100% پس از 30m بدون Alert.

### Rollback
- Trigger: هرکدام از {DLQ>5%، p95>2s، Error Rate>1%، Site Health Critical}.
- Steps: Pause AS → Disable feature flag → Restore prev tag → Re‑enable.

### Incident
- Sev‑1: Export/Notify Down >15m → War‑room + status هر 10m.
- Sev‑2: Degradation پایداری/کارایی.

---

## Engineering Plane
### 1) Admin Guide (Settings → Forms)
- **Form Selectivity:** صفحهٔ Settings با multi‑select فرم‌های فعال (option: `smartalloc_enabled_forms[]`).
- **Generate GF JSON:** دکمهٔ «Generate JSON» برای هر فرم انتخابی؛ خروجی در `wp-content/uploads/smartalloc/artifacts/` با نام: `gf_form_{id}_v{schemas.gf_form.canonical_version}_{date}.json`.
- **Capability/Nonce:** همهٔ عملیات تحت `manage_smartalloc` + Nonce.

### 2) Action Scheduler (Async)
- **Group:** `smartalloc` (یکتا، کاننیکال)
- **Backoff:** Adapter‑Default (NEXT: 1m,5m,15m,30m + jitter 10–20%)
- **DLQ:** سرویس DLQ + Replay امن از Admin.

### 3) Exporter
- **Template:** "ImportToSabt (1404).xlsx"
- **Mapping Canon:** «Sheet2 ستون‌ها» دقیقاً مطابق لیست کاننیکال (ضمیمه A)؛ Leading‑zeros حفظ؛ تاریخ‌ها ISO‑8601.
- **Priority Rules:** در صورت وجود «کد پستی جایگزین»، همان را بگیر؛ در غیر این صورت «کد پستی».

### 4) Schema Checker (GF)
- **واقعی/سختگیر:** مقایسهٔ اسکیمای فرم با نسخهٔ کاننیکال؛ گزارش سازگاری در Admin.

### 5) Site Health
- تست‌های اختصاصی: UTC Guard، DLQ Backlog، Queue Depth، Export p95، DB/Cache Reachability.

### 6) Security
- **Capabilities:** `manage_smartalloc` برای همهٔ صفحات/اکشن‌ها.
- **Nonces:** همهٔ فرم‌های Admin.
- **I/O:** خروجی فقط در `uploads/smartalloc/` و `build/`.

### 7) Testing & CI
- **Unit/Integration/E2E:** پوشش ≥80%.
- **Artifacts:** `build/coverage/summary.json`, `build/patch-guard.json`, `build/pdi/report.json`, `build/testdox.json`, `build/failures.json`.
- **Patch Guard:** محدودیت فایل/LoC، منع IO خارج از `build/`، پرچم زرد روی non‑UTC.

---

## PDI (Append‑Only)
> نتایج اجرا، بنچمارک، و آرتیفکت‌های قابل دانلود هر استقرار در این بخش ثبت می‌شود. این فصل تغییرات **Append‑Only** دارد و تاریخچه را حفظ می‌کند.

- `YYYY‑MM‑DD` — لینک آرتیفکت‌ها (coverage, patch‑guard, utc‑sweep, perf, site‑health).

---

## KPI Golden Table
| KPI | هدف | آلارم | منبع |
|---|---|---|---|
| DLQ Ratio | ≤1% | ≥5% Sev‑1 | DLQMetrics |
| Export p95 | ≤2s | ≥3s Sev‑2 | Perf logs |
| Queue Depth | <100 | ≥500 Sev‑2 | AS Metrics |
| Error Rate | <0.5% | ≥1% Sev‑1 | App logs |
| UTC Violations | 0 | >0 Sev‑2 | UTC Sweep |

---

## Config Notes (Canon)
- **GF Form:** v2.2 (NEXT: 2.8)
- **Exporter Config:** v1.0 — Sheet2, Sheet5, 9394؛ normalizers: digits_10, digits_16, mobile_ir.
- **Mappings:** group_code_by_label (EX/MA/HU/AR/LA)
- **Crosswalks:** `city_by_school_code` (مشتق «شهر مدرسه 1» از «کد مدرسه 1»)

---

## Docs CI Lint (نمونهٔ Workflow)
```yaml
name: docs-lint
on: [push, pull_request]
jobs:
  validate-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Enforce SSOT
        run: |
          # 1) Action Scheduler must be single-group
          if grep -R "smartalloc_\(allocate\|export\|notify\)" -n docs/; then
            echo "Forbidden group names found" && exit 1; fi
          # 2) Version banner
          grep -R "version: 1.0.0-rc.2" -n docs/ || (echo "Version banner missing" && exit 1)
          # 3) Backoff phrasing
          if grep -R "1m,5m,15m,30m" -n docs/; then
            echo "Backoff policy must be marked as NEXT, not current" && exit 1; fi
```

---

### ضمیمه A — Canonical Columns (Sheet2)
> لیست ستون‌های Sheet2 مطابق «ImportToSabt (1404)»؛ ترتیب و نام‌گذاری کاننیکال هستند و مپینگ Exporter Config باید دقیقاً از همین نام‌ها استفاده کند.

1. پشتیبان  
2. کد ثبت نام  
3. گروه آزمایشی  
4. جنسیت  
5. وضعیت ثبت نام  
6. اتباع خارجی  
7. کد ملی  
8. نام  
9. نام خانوادگی  
10. نام پدر  
11. تاری//خ/ /تولد  
12. وضعیت تحصیلی  
13. وضعیت هنرستان  
14. تلفن  
15. تلفن همراه  
16. معدل  
17. معدل نیم سال  
18. شماره قبض  
19. کد پستی  
20. آدرس پست الکترونیک  
21. آدرس  
22. کد پستی جایگزین  
23. پشتیبان خاص  
24. آزمون پیشرفت تحصیلی  
25. كار در منزل و مجله  
26. آزمون CD  
27. زبان خارجی  
28. اقلیت مذهبی  
29. شماره پرونده  
30. نسبت  
31. تخفیف  
32. نحوه آشنایی با کانون  
33. نسبت رابط 1  
34. نام رابط 1  
35. تلفن رابط 1  
36. نسبت رابط 2  
37. نام رابط 2  
38. تلفن رابط 2  
39. شهر مدرسه 1  
40. کد مدرسه 1  
41. شماره کلاس  
42. سهمیه کنکور  
43. شماره صندلی  
44. تاریخ ثبت نام  
45. کد رهگیری حکمت  
46. نوع بسته حکمت  