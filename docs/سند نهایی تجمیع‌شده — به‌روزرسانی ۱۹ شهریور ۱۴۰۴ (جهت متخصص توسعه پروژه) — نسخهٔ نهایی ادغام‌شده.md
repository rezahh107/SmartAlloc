# ุณูุฏ ููุง ุชุฌูุนโุดุฏู โ ุจูโุฑูุฒุฑุณุงู ฑน ุดูุฑูุฑ ฑดฐด (2025-09-07) โ ูุณุฎูู ููุง ุงุฏุบุงูโุดุฏู

Note: Patch Guard: branch-type limits โ see `PATCH_GUARD_STANDARDS_WordPress_2025-09-07.md` (feature โค20/600; hotfix โค5/150; bugfix โค8/200; refactor โค15/500; perf โค12/350; security โค8/200; docs โค30/800; tests โค25/700; i18n โค50/1000; migration โค15/400; compatibility โค10/300).

## ๐ฏ PROJECT LEADERSHIP PULSE (vs. Baseline: 10 ุดูุฑูุฑ 1404)

**Phase:** foundation (Target: ูพุดุชู ุฎุทู ูุจูุง)
**Progress:** โ ถธูช (Baseline: ธฐูช)

### โ๏ธ Top 3 Deviations & Actions

1.  **RuleEngine Composite โ ูฺฏูุจุงู ุนูู (maxDepth=4) ู ูุฏุฑุช ุงูพุฑุงุชูุฑ ูุงูุนุชุจุฑ ฺฉุงูู ูุณุช**
    *   **Impact:** High
    *   **Action:** ุชฺฉูู `evaluateCompositeRule()` + ุชุณุชโูุง ููู (Invalid operator/Too-deep)
    *   **Owner:** Core

2.  **NotificationService โ ูุจูุฏ throttling ูพูุง ู ูุจูุฏ ุดุงุฎุตโูุง DLQ ุฏุฑ ูุชุฑฺฉโูุง**
    *   **Probability:** 60% ยท **Impact:** Medium
    *   **Mitigation:** ุชูุธูุงุช ูพูุง (ููุชุฑ/Option)ุ ุดูุงุฑูุฏูโูุง `notify.rate_limited` ู `dlq.size`ุ ูุณุฑ ุจุงุฒุงุฌุฑุง ุงูู
    *   **Owner:** Core + Comms

3.  **GF Double-processing Risk โ ุฏู ูุณุฑ ููุงุฒ ุจุฑุง `gform_after_submission`**
    *   **Impact:** High
    *   **Action:** ุงูุชุฎุงุจ ูุณุฑ ูุงุญุฏ (ุฑุฌุณุชุฑ per-form ุง generic) ู Deprecate ูุณุฑ ุฏฺฏุฑ
    *   **Owner:** Core

## ๐ Baseline Comparison (YAML)

```yaml
baseline_comparison:
  ref_date: "2025-09-07"
  phase: "foundation"
  progress_current: "โ66โ70%"
  progress_baseline: "80%"
  critical_gaps:
    - "RuleEngine: ูฺฏูุจุงู ุนูู/ุงูพุฑุงุชูุฑ ูุงูุนุชุจุฑ + ุชุณุชโูุง ููู"
    - "NotificationService: throttling ูพูุง + DLQ metrics"
    - "GF double-processing: ฺฉ ูุณุฑ ูุงุญุฏ ุจุฑุง after_submission"
  emerging_risks:
    - "UTC invariants: ุงุณุชูุงุฏู ุงุฒ current_time('mysql') ุจุฏูู GMT=true"
    - "SchemaChecker ุตูุฑ โ ุจุงุฏ ูุฌูุฏ/ููุน ููุฏูุง ฺฉูุฏ ุฑุงุณุชโุขุฒูุง ุดูุฏ"
  advancement_opps:
    - "Plugin Health ุฏุฑ Site Health + Wrapperูุง (PluginGuard/GFBridge/ASBridge)"
    - "Action Scheduler ุจูโุนููุงู ุตู ุงุณุชุงูุฏุงุฑุฏ + DLQ/Backoff"
```

## ๐ง Plugin Integration Policy (ุฎูุงุตู ู ุงูุฒุงูโุขูุฑ)

*   **Forms:** Gravity Forms (ูุทุนุ ููุจุน ุญููุช ุฌูุนโุขูุฑ ุฏุงุฏู). ูุฑู v2 ุจุง ููุฏูุง ฺฉูุฏ (ID: 143, 92, 93, 20, 21, 23, 30, 29, 94, 75, 76, 60, 61, 39, 99, 150, 151).
*   **Queue/Async:** Action Scheduler (Must-Have) โ ฺฏุฑูู `smartalloc`, backoff: 1mโ5mโ15mโ30mุ ุญุฏุงฺฉุซุฑ ด ุชูุงุดุ DLQ ูุนุงู.
*   **Mentor Populate (#39):** Hybrid โ ุงฺฏุฑ GPPA ุญุงุถุฑ ุจูุฏ Live/AJAXุ ุงฺฏุฑ ูุจูุฏ Fallback ุฏุงุฎู (ููฺฉโูุง GF). ููุฏูุง ูุงุจุณุชู: 92, 93, 94, 75.
*   **Email:** SMTP ููุท Prod (WP Mail SMTP ุจุง SPF/DKIM/DMARC)ุ Dev: Mail Log + ูุงุณฺฉ PII.
*   **Rule-of-One:** WP Webhooks/Automator ูุนูุงู ูุตุจ ูุดูุฏ (Webhook ุฏุงุฎู ฺฉูุงุช ูโฺฉูุฏ).
*   **UTC:** ุฐุฎุฑูโุณุงุฒ ุฒูุงูโูุง ุฏุฑ UTC (`current_time('mysql', true)`/`gmdate()`/`current_time('timestamp', true)`)ุ ููุงุด ูุญู ุตุฑูุงู ุฏุฑ UI.
*   **SchemaChecker:** ูุงูุนโุณุงุฒ ุจุฑุฑุณ ูุฌูุฏ/ููุน ููุฏูุง ฺฉูุฏ GF (IDs ุญุงุช: 39, 20, 92, 93, 94, 75, ...) ู ฺฏุฒุงุฑุด ยซCompatibilityยป ุฏุฑ UI.

## โก๏ธ Weekly Priorities (Baseline-Aligned)

1.  RuleEngine Composite + ุชุณุชโูุง ููู (Invalid/Too-deep)
2.  Notification throttling ูพูุง + DLQ metrics + Replay ุงูู
3.  Action Scheduler Switch (ูพุดโูุฑุถ ุตู) + ฺฏุฑููโูุง ู Backoff
4.  SchemaChecker ูุงูุน + ุญุฐู ุฏูฺฏุงูฺฏ ูุณุฑ GF

## ๐ฏ KPI ู ุขุณุชุงููโูุง

*   **Queue:** Failed < ฑูช, p95 ุงูุชุธุงุฑ < ฑฐs, DLQ โค ต
*   **Allocation:** p95 < ธฐms, Capacity deviation โค ตูช, Mentor conflict = ฐ
*   **Export:** Peak mem < ฑฒธMB, Build โค ฒs (@Nโ1000), CSV-Injection = ฐ
*   **Comms:** Delivery โฅ นธูช, Duplicate = ฐ
*   **Forms:** Submission error < ฐ.ตูช, GF schema compatibility = ฑฐฐูช

## ๐ Baseline Achievement Matrix (Critical Items Only)

| Component  | Baseline Target          | Current Status | Action                                        | Owner   |
| ---------- | ------------------------ | -------------- | --------------------------------------------- | ------- |
| RuleEngine | Composite AND/OR + Depth | ูุงูุต           | ุชฺฉูู evaluateCompositeRule + ุชุณุช ุนูู/ุงูพุฑุงุชูุฑ | Core    |
| Security   | โฅ 20                     | 21 (ุจูุจูุฏูพุฐุฑ) | ุณูุชโฺฉุฑุฏู ูุฑูุฏโูุง ุฏุฑ DLQ/Webhook/UTC            | Sec     |
| Export     | Streaming + CSV-Safe     | ูููโฺฉุงูู       | ุญุฏ ุญุงูุธู + ุถุฏ CSV-Injection ุชุฃุฏ ูุฌุฏุฏ        | Core+QA |

## โ Decisions (ุซุจุชโุดุฏู ุจุฑุง ูุจูุง)

*   ุชุซุจุช GF ุจูโุนููุงู ุฒุฑุณุงุฎุช ูุฑู (ุจุฏูู ุชุบุฑ ูุณุฑ ูุนู).
*   ููุงุฌุฑุช ุตู ุจู Action Schedulerุ WP-Cron ููุท fallback.
*   Mentor#39 ุจูโุตูุฑุช Hybrid (GPPA ุงุฎุชุงุฑ) ุจุง Wrapper ู Fallback ุฏุงุฎู.
*   SMTP ููุท Prodุ Dev ููุท Mail Log ุจุง ูุงุณฺฉ PII.
*   ุงุนูุงู Rule-of-One ุฑู ุงุชููุงุณููุ ูุนูุงู ูุจโููฺฉ ุฏุงุฎู ฺฉุงู ุงุณุช.
*   ุณูุชโฺฉุฑุฏู UTC ุฏุฑ ุฐุฎุฑูโุณุงุฒ ู ููุงุด ูุญู ุฏุฑ UI.
*   ุชฺฉูู Site Health: Plugin Health Dashboard + KPIูุง.

---

## ---8<--- CLAUDE ARCHITECT PROMPT ---8<---

**FEATURE BRIEF (AUTO-GENERATED FROM STRATEGIC ANALYSIS)**

**๐ฏ Goal**
ุจูโุฑูุฒุฑุณุงู ูุจูุง ุจุง ุณุงุณุช ุงุฏุบุงู ุงูุฒูููโูุงุ ููุงุฌุฑุช ุตู ุจู Action Schedulerุ ูุงูุนโุณุงุฒ SchemaChecker ู ฺฉโูุณุฑูโฺฉุฑุฏู GF submissionุ ุจุณุชู ุดฺฉุงูโูุง RuleEngine Composite ู Throttling/DLQ.

**๐ฆ Scope (Baseline-Informed)**
*   Wrapperูุง: PluginGuard, GFBridge, ASBridge
*   Action Scheduler Groups/Backoff/DLQ
*   SchemaChecker ูุงูุน + ุญุฐู ูุณุฑ ููุงุฒ GF
*   KPIูุง ู Site Health: Plugin Health
*   ุจุฏูู ุชุบุฑ ุฏุฑ ููุทู ูุณุชู Allocation/Export

**๐ Baseline Requirements**
*   ุชฺฉูู ุขุชูโูุง Foundation ุจุญุฑุงู
*   Security โฅ 22ุ Performance โฅ 19ุ Weighted โฅ 95%
*   UTC invariants ุฑุนุงุช ุดูุฏุ ุจุฏูู ุฑฺฏุฑุณูู

**โ๏ธ Constraints**
*   Patch Guard: branch-type caps (feature โค20/600; hotfix โค5/150; bugfix โค8/200; refactor โค15/500; perf โค12/350; security โค8/200; docs โค30/800; tests โค25/700; i18n โค50/1000; migration โค15/400; compatibility โค10/300). See `PATCH_GUARD_STANDARDS_WordPress_2025-09-07.md`.
*   WordPress standards: prepared SQL, capability checks, UTC
*   Baseline Compliance: ุจุฏูู ุฑฺฏุฑุณูู

**ROLE:** Principal Software Architect for SmartAlloc (WordPress) with Baseline Compliance.
**NON-NEGOTIABLES:** prepared SQL; capability checks; nonce; typed exceptions; UTC; WP standards; baseline alignment.

**INPUT โ Feature Brief:** [SEE ABOVE] + Baseline Requirements

**OUTPUT (STRICT):**

**PHASES (YAML)**
```yaml
baseline_update:
  phase: foundation
  goals:
    - migrate_queue_to_as
    - unify_gf_submission_path
    - implement_schema_checker_real
    - add_plugin_health_site_health
  deliverables:
    - src/Integration/ASBridge.php
    - src/Integration/PluginGuard.php
    - src/Infra/GF/SchemaChecker.php (real)
    - src/Admin/Status/PluginHealth.php
  5d_targets:
    security: 22
    logic: 18
    performance: 19
    readability: 19
    goal: 14
```

**TECH SPEC (MD)**

*   **ASBridge:** `queue($hook, $args, $delay, $group='smartalloc')` ุจุง backoff ููุง ู DLQ hook. ูพุงุฏูโุณุงุฒ `RetryService` ุจุง jitter ู `DlqService` ุจุฑุง ูุฏุฑุช ุตู ูุฑุฏู.
*   **SchemaChecker:** ุงุนุชุจุงุฑ ููุฏูุง ฺฉูุฏ GF (IDs ุญุงุช)ุ ุฎุฑูุฌ ุณุงุฒฺฏุงุฑ ุจุฑุง UI FormsScreen. ุจุฑุฑุณ ูุฌูุฏุ ููุน ู ุงูุฒุงูโุจูุฏู ููุฏูุง.
*   **PluginHealth:** ุชุณุช ูุณุฎู/ูุนุงูโุจูุฏู ุงูุฒูููโูุง (GF, AS, SMTP)ุ Rule-of-Oneุ ูุถุนุช DLQ/ASุ UTC invariant. ุฎุฑูุฌ ุงูุฏุงูโูุญูุฑ ุจุง ููฺฉ ุจู ุตูุญุงุช ูุฑุจูุทู.
*   **GF Single Path:** ุชููุง `gform_after_submission_{formId}` ูุนุงู. ูุณุฑ generic ุบุฑูุนุงู/Deprecated. ูพุงุฏูโุณุงุฒ `IdempotencyGuard` ุจุฑุง ุฌููฺฏุฑ ุงุฒ ูพุฑุฏุงุฒุด ุชฺฉุฑุงุฑ ุจุฑ ุงุณุงุณ `entry_id`.

**TEST PLAN (MD)**

*   ูุงุชุฑุณ CI ยซุจุง/ุจโุงูุฒูููยป ุจุฑุง fallback (GPPA/AS).
*   ุชุณุช double-processing GF: ุชููุง ฺฉ ูุณุฑ ูุนุงู ุจุงุดุฏุ ุชุณุช idempotency.
*   ุชุณุช AS: failed actions ุซุจุช ู ูุงุจู replayุ backoff pattern ุตุญุญ.
*   ุชุณุชโูุง ููู RuleEngine: ุนูู > 4ุ ุงูพุฑุงุชูุฑ ูุงูุนุชุจุฑ.
*   ุชุณุชโูุง UTC: ูฺ ุงุณุชูุงุฏูโุง ุงุฒ `current_time('mysql')` ุจุฏูู `GMT=true` ูุฌูุฏ ูุฏุงุดุชู ุจุงุดุฏ.

**CODEX PROMPT (MD) โ minimal diffs + exact paths**

*   ุงูุฒูุฏู ูุงูโูุง ููู (โค25 LoC ูุฑ ฺฉุฏุงู)ุ ุชุบุฑุงุช ููุถุน Bootstrap (โค10 LoC).
*   ุชุบุฑุงุช Diff-Only ุจุง ูุณุฑ ุฏูู ูุงูโูุง.

**5D TARGETS (YAML)**
```yaml
targets:
  security: {min: 22, goal: 23}
  logic: {min: 18, goal: 18}
  performance: {min: 19, goal: 19}
  readability: {min: 19, goal: 19}
  goal: {min: 14, goal: 15}
```

**BASELINE IMPACT ASSESSMENT**

*   **Risk โ:** ุญุฐู double-processingุ UTC ุณุฎุชุ ุณูุงูุช ุงูุฒูููโูุง
*   **Speed โ:** ุชุญูู Foundation ุชุง 15โ20% ุณุฑุนโุชุฑ
*   **Quality โ:** ุซุจุงุช ุตู/ูุจโููฺฉ/ูุฑูุ ฺฉุดู ุฑฺฏุฑุณููโูุง ุงูุฒูููโุง

---

## ---8<--- END ---8<---

## ุถููู: ูุณุฎูู ูุจู (ุจุฑุง ูุฑุฌุน)

*(ูุญุชูุง "ุณูุฏ ูุจูุง ุจุฑุง ุงุฏุงูู ุชูุณุนู ุงูุฒููู" ู "ุณูุฏ ููุง ุชุฌูุนโุดุฏู: ุชุญูู ูุถุนุช ู ููุดูโ ุฑุงู SmartAlloc" ุงุฒ ูุงู ุงูู ุญูุธ ูโุดูุฏุ ุงูุง ุงุฒ ุขูุฌุง ฺฉู ุณุงุฎุชุงุฑ ุงุตู ู ุฌุฒุฆุงุช ูู ุฏุฑ ุจุฎุดโูุง ุจุงูุง ู ุฏุฑ ุงุฏุงููู ุงู ุณูุฏ ฺฉุงููโุชุฑ ุงุฏุบุงู ุดุฏูโุงูุฏุ ุฏุฑ ุงูุฌุง ุชฺฉุฑุงุฑ ููโุดูุฏ.)*

---

## ุณูุฏ ููุง ุชุฌูุนโุดุฏู: ุชุญูู ูุถุนุช ู ููุดูโ ุฑุงู SmartAlloc (ูุณุฎูู ููุง ุงุฏุบุงูโุดุฏู)

### 1. ูุนุฑู ูพุฑูฺู ู ุฒููู ฺฉู

**ูพุฑูฺู:** ุณุณุชู ุชุฎุตุต ุฎูุฏฺฉุงุฑ ุฏุงูุดโุขููุฒ ุจู ูพุดุชุจุงู (SmartAlloc) ุจุฑ ูพุงู ูุฑุฏูพุฑุณ
**ูุฏู ุงุตู:** ุงูุฒูููู ูุฑุฏูพุฑุณ ุชููุฏ-ุขูุงุฏู ุจุฑุง ุชุฎุตุต ุฎูุฏฺฉุงุฑ ยซูพุดุชุจุงูยป ุจู ยซุฏุงูุดโุขููุฒยป ุจุง ูุนูุงุฑ Event-Drivenุ Command Patternุ DI Containerุ Cache ุณูโูุงูุ Observability (Health, Metrics, Circuit Breaker) ู ุงุฏุบุงู ฺฉุงูู ุจุง Gravity Forms.
**ูพุดโูุงุฒูุง:** WP โฅ 6.4, PHP โฅ 8.1, MySQL 8+/MariaDB 10.5+
**ููุงูุฑโูุง ฺฉูุฏ:** ูุฑุฏูพุฑุณุ PHP 8.1+ุ Gravity Forms Proุ PhpSpreadsheetุ (ุงุฎุชุงุฑ) Redis Object Cache / Object Cache Pro
**ุงูุฒูููโูุง ุถุฑูุฑ:** Gravity Forms, Action Scheduler, (Prod ููุท) WP Mail SMTP, (ุงุฎุชุงุฑ) GP Populate Anything.

### 2. ุจุฑุฑุณ ูุถุนุช ูุนู ูพุฑูฺู ุจุฑ ุงุณุงุณ ุณูุฏ ุงุฌุฑุง

ุจุฑุฑุณ ุฏูู ูพุฑูฺู ูุดุงู ูโุฏูุฏ ฺฉู ุงฺฏุฑฺู ุจุณุงุฑ ุงุฒ ูฺฺฏโูุง ุงุตู ูพุงุฏูโุณุงุฒ ุดุฏูโุงูุฏุ ุงูุง ฺูุฏู ุจุฎุด ุญุงุช ูุงุฒ ุจู ุชฺฉูู ู ุจูููโุณุงุฒ ุฏุงุฑูุฏ:

*   **ูุถุนุช ฺฉู:** ูพุฑูฺู ุฏุฑ ูุงุฒ Foundation ูุฑุงุฑ ุฏุงุฑุฏ ู ุญุฏูุฏ ธตูช ุชฺฉูู ุดุฏู ุงุณุชุ ุงูุง ุจุฑุฎ ุจุฎุดโูุง ุญุงุช ุงุฒ ูุธุฑ ูู ูููโฺฉุงุฑู ุจุงู ูุงูุฏูโุงูุฏ.
*   **ูพูุดุด ุชุณุช:** ุญุฏูุฏ ทฐ-ธฐูชุ ุงูุง ูพูุดุด ุจุฑุง ุณูุงุฑููุง ุชุฑฺฉุจ ู ูุณุฑูุง ุจุญุฑุงู ูุงฺฉุงู ุงุณุช.
*   **ุฑุณฺฉโูุง ฺฉูุฏ:**
    *   ุนุฏู ูพุงุฏูโุณุงุฒ ฺฉุงูู ุณุณุชู ุงุนูุงูุงุช (Throttling/DLQ).
    *   ูุงุฒ ุจู ุงุณุชุงูุฏุงุฑุฏุณุงุฒ ู ุชุงูพโุฏู ุฏูู ุฏุฑ ูุฏุงุฑุดฺฉู.
    *   ูุงุฒ ุจู ูพุดุชุจุงู ุงุฒ ุดุฑุงุท ุชุฑฺฉุจ ุฏุฑ ููุชูุฑ ููุงุนุฏ.
    *   ุนุฏู ุจูููโุณุงุฒ ุจุฑุง ูุงูโูุง ุญุฌู ุฏุฑ ุฎุฑูุฌโฺฏุฑ ุงฺฉุณู.
    *   ุนุฏู ุชุถูู ูุณุฑ ูุงุญุฏ ุจุฑุง ูพุฑุฏุงุฒุด ูุฑูโูุง Gravity Forms.

### 3. ุชุญูู ุฏูู ูุงูโูุง ูพุฑูฺู ู ูุงุฒูุง ุชฺฉูู

#### 3.1 ูุงู ฺฉุงุฑุจุฑุฏ - NotificationService

**ุจุฑุฑุณ ุจุง ุณูุฏ ุงุฌุฑุง:**
ุณูุฏ v1.2 ุงูุฒุงู ูโฺฉูุฏ ุชุนุฏุงุฏ ุชูุงุดโูุง ุงุฑุณุงูุ ุณุงุณุชโูุง throttle ู ุงุฑุณุงู ุจู DLQ ุจูโุตูุฑุช ูพุงุฑุงูุชุฑฺฉ ู ูุงูุชูุฑโุดุฏู ุจุงุดุฏ.

**ูุถุนุช ูุนู:**
*   ุงุณุชูุงุฏู ุงุฒ ุซุงุจุช `SMARTALLOC_NOTIFY_MAX_TRIES` ุงูุฌุงู ุดุฏู ุงุณุชุ ุงูุง ูฺ ูฺฉุงูุฒู ูุฑุฎโฺฏุฐุงุฑุ ุดูุงุฑุด ุดฺฉุณุช ุณุฑุงุณุฑ ุง ุงุชุตุงู ูุณุชูู ุจู DLQ/ูุชุฑฺฉโูุง ูพุงุฏู ูุดุฏู ุงุณุช.
*   ููุฏุงุฑ ูพุดุชุจุงู ุงุฒ ุจุงุฑ ุฏุฑ `handle()` ุงุตูุงุญ ุดุฏู ุงูุง ุฏุฑ `sendMail()` ูููุฒ ุจูโุตูุฑุช ุซุงุจุช ูุฑุงุฎูุงู ูโุดูุฏ.

**ูุดฺฉูุงุช ุดูุงุณุงโุดุฏู:**
*   ุนุฏู ูุญุฏูุฏุณุงุฒ ูุฑุฎ (throttle) ุฏุฑ ูุชุฏ `handle`.
*   ูุจูุฏ ุซุจุช ูุชุฑฺฉ ุชูุตู ุจุฑุง DLQ ู ุดูุงุฑุด ุชูุงุดโูุง ูุฌููุน.
*   ูุฑุงุฎูุงู ุซุงุจุช ุจู `SMARTALLOC_NOTIFY_MAX_TRIES` ุจุฏูู ุจุฑุฑุณ ุชุนุฑูโุดุฏู.
*   ูุจูุฏ throttling ุจุฑุง ุฌููฺฏุฑ ุงุฒ flood ุงุฑุณุงู.
*   ุนุฏู ุงูุชุดุงุฑ ุฑูุฏุงุฏ ูุงูุชูุฑูฺฏ ููฺฏุงู push ุจู DLQ.

**ฺฉุฏูุง ูพุดููุงุฏ ุจุฑุง ููุดุชู:**

```php
// ุฏุงุฎู sendMailุ ูุจู ุงุฒ ููุงุณูู ุชูุงุดโูุง
$maxTries = defined('SMARTALLOC_NOTIFY_MAX_TRIES') ? (int)SMARTALLOC_NOTIFY_MAX_TRIES : 5;

// ุงูุฒูุฏู RateLimiter ุจุง ุงุณุชูุงุฏู ุงุฒ ุชุฑุงูุฒ ูุชโูุง
private function throttle(string $key, int $limitPerMin): void {
    $count = (int) get_transient($key) ?: 0;
    if ($count >= $limitPerMin) {
        $this->metrics->inc('notify_throttle_hits_total');
        throw new \RuntimeException('Throttle limit reached');
    }
    set_transient($key, $count + 1, 60);
}

// ุงุณุชูุงุฏู ุฏุฑ ูุชุฏ handle
public function handle(array $payload): void {
    $attempt = (int) ($payload['_attempt'] ?? 1);
    
    // ุงุนูุงู Throttling
    $this->throttle('notify_' . gmdate('YmdHi'), SMARTALLOC_NOTIFY_RATE);

    if ($attempt >= $maxTries) {
        $this->eventBus->dispatch('notification.final_failure', [
            'correlation_id' => $this->correlationId,
            'payload' => $payload,
            'attempts' => $attempt
        ]);
        $this->dlqService->push($payload, 'notification');
        $this->metrics->increment('notification.dlq');
        return;
    }
    // ... ุงุฏุงูู ุนููุงุช
}
```

**ุชุณุชโูุง ููุฑุฏ ูุงุฒ:**

| ูุงู ุชุณุช                       | ุณูุงุฑู                                                       | ูพูุดุด        | ุงูุฒุงู                    |
| ----------------------------- | ------------------------------------------------------------ | ----------- | ------------------------ |
| NotificationThrottleTest      | ุงุฑุณุงู 11 ุงุนูุงู ุฏุฑ 60 ุซุงูู                                   | Unit        | ุฌููฺฏุฑ ุงุฒ flood         |
| NotificationRetryLimitTest    | ุชูุงุดโูุง ุจุด ุงุฒ SMARTALLOC_NOTIFY_MAX_TRIES                   | Unit        | ุงุญุชุฑุงู ุจู ููุฏุงุฑ ูพฺฉุฑุจูุฏ |
| NotificationDlqMonitoringTest | ุงุฑุณุงู ุจู DLQ ู ุงูุชุดุงุฑ ุฑูุฏุงุฏ                                 | Integration | ูุงูุชูุฑูฺฏ ฺฉุงูู          |
| NotificationThrottleTest      | ุงุฑุณุงู ุจุด ุงุฒ SMARTALLOC_NOTIFY_RATE ุฏุฑ ฺฉ ุฏููู ู ุงูุชุธุงุฑ ุฎุทุง | Unit        | p95 < 50ms               |

#### 3.2 ูุงู ฺฉุงุฑุจุฑุฏ - CircuitBreaker

**ุจุฑุฑุณ ุจุง ุณูุฏ ุงุฌุฑุง:**
ูุฏุงุฑุดฺฉู ุจุงุฏ ุฎุฑูุฌโูุง type-safe ู ฺฉุฏ ูุทุงุจู ุงุณุชุงูุฏุงุฑุฏ ูุฑุฏูพุฑุณ ุจุงุดุฏุ ุงุณุชูุงุฏู ุงุฒ ุซุงุจุชโูุง ุชูุธูุงุช.

**ูุถุนุช ูุนู:**
*   ฺฉุฏ ุจุง `// phpcs:ignoreFile` ููุดุชู ุดุฏู ู ุงุณุชุงูุฏุงุฑุฏูุง ูุฑุฏูพุฑุณ ุฑุง ูุงุฏุฏู ูโฺฏุฑุฏ.
*   ุฎุฑูุฌโูุง ุจุฏูู ููุน ุฏุฑ `getStatus` ู `getStatusReport` ุฏุฑ CircuitBreaker.
*   ุนุฏู ุงุณุชูุงุฏู ุงุฒ ุซุงุจุชโูุง ูพฺฉุฑุจูุฏโุดุฏู ุฏุฑ ุชูุธูุงุช.

**ูุดฺฉูุงุช ุดูุงุณุงโุดุฏู:**
*   ุจุงุฒฺฏุฑุฏุงูุฏู ุขุฑุงู ุจุฏูู ุชุนุฑู ุฏูู ููุน ู ุญุฐู ฺฉุงูู PHPCS.
*   ุนุฏู ุงุณุชูุงุฏู ุงุฒ ุซุงุจุชโูุง ูพฺฉุฑุจูุฏ ุฏุฑ ุณุงุฒูุฏู.
*   ุนุฏู ูพูุดุด ุญุงูุชโูุง ุชุฑฺฉุจ (ุดุจฺฉู ู ุฏุชุงุจุณ) ุฏุฑ ุชุณุชโูุง.
*   ุนุฏู ูพุดุชุจุงู ุงุฒ Threshold/Cooldown ุงุฒ ุชูุธูุงุช.

**ฺฉุฏูุง ูพุดููุงุฏ ุจุฑุง ููุดุชู:**

```php
// DTO ุจุฑุง ูุถุนุช ูุฏุงุฑุดฺฉู
class CircuitBreakerStatus {
    public function __construct(
        public bool $isOpen,
        public ?int $failureCount,
        public ?int $openedAt,
        public ?int $nextAttempt,
        public string $serviceName
    ) {}
    
    public function toArray(): array {
        return [
            'is_open' => $this->isOpen,
            'failure_count' => $this->failureCount,
            'opened_at' => $this->openedAt,
            'next_attempt' => $this->nextAttempt,
            'service_name' => $this->serviceName
        ];
    }
}

// ุฏุฑ ฺฉูุงุณ CircuitBreaker
public function __construct(
    int $threshold = SMARTALLOC_CB_THRESHOLD,
    int $cooldown = SMARTALLOC_CB_COOLDOWN,
    ?callable $halfOpenCallback = null,
    ?CircuitStorage $storage = null
) {
    $this->threshold = $threshold;
    $this->cooldown = $cooldown;
    $this->halfOpenCallback = $halfOpenCallback;
    $this->storage = $storage ?: new TransientCircuitStorage();
}

public function getStatus(): CircuitBreakerStatus {
    $status = $this->getStatusArray();
    return new CircuitBreakerStatus(
        $status['is_open'],
        $status['failure_count'],
        $status['opened_at'],
        $status['next_attempt'], 
        $this->serviceName
    );
}

private function getStatusArray(): array {
    $failureCount = $this->counter->get($this->failureKey);
    $openedTs = $this->counter->get($this->openedKey);
    $nextAttempt = null;
    
    if ($openedTs && $openedTs > 0) {
        $nextAttempt = $openedTs + $this->config->cooldown;
    }
    
    return [
        'is_open' => $this->isOpen(),
        'failure_count' => $failureCount,
        'opened_at' => $openedTs,
        'next_attempt' => $nextAttempt ? $nextAttempt : null,
    ];
}
```

**ุชุณุชโูุง ููุฑุฏ ูุงุฒ:**

| ูุงู ุชุณุช                         | ุณูุงุฑู                                                    | ูพูุดุด        | ุงูุฒุงู               |
| ------------------------------- | --------------------------------------------------------- | ----------- | ------------------- |
| CircuitBreakerStatusTypeTest    | ุจุฑุฑุณ ููุน ุจุงุฒฺฏุดุช getStatus                               | Unit        | ุชุงูพโุฏู ุฏูู        |
| CircuitBreakerMixedFailuresTest | ุชูุงู ุฎุทุงูุง ุดุจฺฉู ู ุฏุชุงุจุณ ุจุง ุขุณุชุงูู ูุดุชุฑฺฉ               | Integration | Branch โฅ 85%        |
| CircuitBreakerComboFailureTest  | ุดฺฉุณุช ุชุฑฺฉุจ ุดุจฺฉู+DB ู ุจุฑุฑุณ ุฑุณุช                          | Integration | ูพูุดุด ุญุงูุชโูุง ุชุฑฺฉุจ |
| SettingsOverrideTest            | ุชุบุฑ ููุงุฏุฑ threshold/cooldown ุงุฒ Settings ู ุจุฑุฑุณ ุฑูุชุงุฑ | Unit        | โ                   |

#### 3.3 ูุงู ฺฉุงุฑุจุฑุฏ - Rule Engine

**ุจุฑุฑุณ ุจุง ุณูุฏ ุงุฌุฑุง:**
ูพุดุชุจุงู ุงุฒ ุดุฑุงุท AND/ORุ ุซุจุช ุงูฺฏููุง ููุทู ุฏุฑ EvaluationResult ู ุชุณุชโูุง ุฌุงูุน.

**ูุถุนุช ูุนู:**
*   ููุชูุฑ ููุท ฺฉ ุดุฑุท ุณุงุฏู fuzzy-score ุฏุงุฑุฏ ู ูุฏู ูุชุฌู ูุงูุฏ ุณุงุฎุชุงุฑ ููุทู ุงุณุช.
*   ุชุณุชโูุง `RuleEngineControllerTest` ุจุง `markTestIncomplete` ุฑูุง ุดุฏูโุงูุฏ.
*   ูุฏู `EvaluationResult` ูุงูุฏ ููุงุด ุฏุฑุฎุช ููุทู (trace) ุงุณุช.

**ูุดฺฉูุงุช ุดูุงุณุงโุดุฏู:**
*   ุนุฏู ูพุดุชุจุงู ุงุฒ ุดุฑุงุท ุชุฑฺฉุจ (AND/OR) ุฏุฑ ููุงุนุฏ.
*   `EvaluationResult` ุงูฺฏู ููุทู ุชุตูู ุฑุง ุฐุฎุฑู ููโฺฉูุฏ.
*   ุชุณุชโูุง REST ุจุฑุง ููุชูุฑ ููุงุนุฏ ูุงูุต ุงุณุช.
*   ุนุฏู ูพุดุชุจุงู ุงุฒ ุชุฑฺฉุจ ุดุฑุงุท.

**ฺฉุฏูุง ูพุดููุงุฏ ุจุฑุง ููุดุชู:**

```php
// EvaluationResult ุจุง ูพุดุชุจุงู ุงุฒ ุฏุฑุฎุช ููุทู
class EvaluationResult {
    /** @var 'auto'|'manual'|'reject' */
    public string $decision;
    /** @var array<string,string> */
    public array $reasons = [];
    /** @var array<string,float> */
    public array $scores = [];
    /** @var array{op:string, rules:array<array<string,mixed>>} */
    public array $logicTree = [];

    public function __construct(string $decision = 'reject') {
        $this->decision = $decision;
    }

    public function addReason(string $reason): void {
        $this->reasons[] = $reason;
    }

    public function addScore(string $key, float $score): void {
        $this->scores[$key] = $score;
    }

    public function setLogicTree(array $tree): void {
        $this->logicTree = $tree;
    }
}

// Rule Engine ุจุง ูพุดุชุจุงู ุงุฒ AND/OR
class RuleEngineService {
    private array $rules;
    
    public function __construct(array $rules) {
        $this->rules = $rules;
    }
    
    private function compare(mixed $actual, mixed $expected, string $operator): bool {
        switch ($operator) {
            case '>=': return $actual >= $expected;
            case '<=': return $actual <= $expected;
            case '>': return $actual > $expected;
            case '<': return $actual < $expected;
            case '==': return $actual == $expected;
            case '!=': return $actual != $expected;
            case '===': return $actual === $expected;
            case '!==': return $actual !== $expected;
            default:
                $this->logger->error('rule_engine.invalid_operator', ['operator' => $operator]);
                return false;
        }
    }

    private function evaluateNode(array $node, array $ctx, int $depth = 0): bool {
        if ($depth > 4) {
            throw new TooDeepRuleException("Rule depth exceeds maximum of 4");
        }
        
        if (isset($node['op'])) {
            $results = array_map(fn($r) => $this->evaluateNode($r, $ctx, $depth + 1), $node['rules']);
            return $node['op'] === 'AND' ? !in_array(false, $results, true) : in_array(true, $results, true);
        }
        // Simple condition
        return $this->compare($ctx[$node['field']] ?? null, $node['value'], $node['operator']);
    }

    public function evaluate(array $ctx): EvaluationResult {
        $result = new EvaluationResult('reject');
        
        // ูุซุงู ุจุฑุง ุฏุฑุฎุช ููุทู
        $exampleLogicTree = [
            'op' => 'AND',
            'rules' => [
                ['field' => 'school_fuzzy', 'operator' => '>=', 'value' => 0.90],
                ['field' => 'city', 'operator' => '===', 'value' => ($ctx['preferred_city'] ?? '')]
            ]
        ];
        
        try {
            $logicPassed = $this->evaluateNode($exampleLogicTree, $ctx);
            $result->setLogicTree($exampleLogicTree);

            if ($logicPassed) {
                $result->decision = 'auto';
                $result->addReason('auto_allocation_rules_met');
            } else {
                $result->decision = 'reject';
                $result->addReason('rule_engine_failed');
            }
        } catch (TooDeepRuleException $e) {
            $result->decision = 'reject';
            $result->addReason('rule_too_deep');
        } catch (InvalidRuleOperatorException $e) {
            $result->decision = 'reject';
            $result->addReason('invalid_operator');
        }

        // ุงุถุงูู ฺฉุฑุฏู ุงูุชุงุฒูุง
        $result->addScore('school_fuzzy', (float)($ctx['school_fuzzy'] ?? 0));

        return $result;
    }
}
```

**ุชุณุชโูุง ููุฑุฏ ูุงุฒ:**

| ูุงู ุชุณุช                        | ุณูุงุฑู                               | ูพูุดุด        | ุงูุฒุงู                   |
| ------------------------------ | ------------------------------------ | ----------- | ----------------------- |
| RuleEngineAndOrTest            | ุงุฑุฒุงุจ ููุงุนุฏ ูุฑฺฉุจ AND/OR            | Unit        | ุชุตูู ุตุญุญ ุจุฑ ุงุณุงุณ ุฏุฑุฎุช |
| RuleEngineCompositeAndTest     | ุฏู ุดุฑุท AND                           | Unit        | ุดุฑุงุท ุชุฑฺฉุจ            |
| RuleEngineCompositeOrTest      | OR ุจุง ฺฉ true                       | Unit        | ุดุฑุงุท ุชุฑฺฉุจ            |
| RuleEngineExpressionResultTest | ุฐุฎุฑูู ุฏุฑุฎุช ููุทู ุฏุฑ EvaluationResult | Unit        | ุงูฺฏููุง ููุทู           |
| RuleEngineControllerAuthTest   | ุฏุฑุฎูุงุณุช ุตุญุญ ุจุง ุชุตูู ยซautoยป         | Integration | JSON ุจุง decision        |

#### 3.4 ูฺฏุฑุงูโูุง ุจูโูุงูโุง - Logging & Observability

**ุจุฑุฑุณ ุจุง ุณูุฏ ุงุฌุฑุง:**
ูุงฺฏ ุณุงุฎุชโุงูุชู ุจุง Correlation IDุ Tracer ุฏุฑ ุชูุงู ูุงูโูุง ู ุงูุฏูพููุชโูุง Health/Metrics ฺฉุงูู.

**ูุถุนุช ูุนู:**
*   Logging ูุงูุฏ Correlation ID ุงุณุช.
*   Tracer ููุท ุฏุฑ ุญุงูุช ุชุณุช ู ูุญุฏูุฏ ุงุณุชูุงุฏู ูโุดูุฏ.
*   ุงูุฏูพููุช Health ุชููุง ูุถุนุช ุณุงุฏู ุฏุชุงุจุณ ู ฺฉุด ุฑุง ุจุฑูโฺฏุฑุฏุงูุฏ.

**ูุดฺฉูุงุช ุดูุงุณุงโุดุฏู:**
*   ุนุฏู ุชุฒุฑู Correlation ID ุฏุฑ ููู ูุงฺฏโูุง.
*   ุนุฏู ุงุณุชูุงุฏู ุงุฒ Tracer ุฏุฑ ุชูุงู ูุงูโูุง.
*   ุงูุฏูพููุชโูุง Health/Metrics ูุถุนุช ูุฏุงุฑุดฺฉู ู DLQ ุฑุง ฺฏุฒุงุฑุด ููโฺฉููุฏ.

**ฺฉุฏูุง ูพุดููุงุฏ ุจุฑุง ููุดุชู:**

```php
// Logger ุจุง ูพุดุชุจุงู ุงุฒ Correlation ID
class StructuredLogger implements LoggerInterface {
    private string $correlationId;
    
    public function __construct(?string $correlationId = null) {
        $this->correlationId = $correlationId ?? uniqid('cid-', true);
    }
    
    public function log(string $level, string $message, array $context = []): void {
        $context = array_merge([
            'correlation_id' => $this->correlationId,
            'timestamp' => gmdate('Y-m-d\TH:i:s\Z')
        ], $context);
        
        // ุงุทููุงู ุงุฒ ุนุฏู ูุฌูุฏ ุงุทูุงุนุงุช ุญุณุงุณ
        $context = Redactor::sanitize($context);
        
        // ุงุฑุณุงู ุจู ูุฑุฏูพุฑุณ ูุงฺฏ
        error_log(sprintf(
            "[%s] %s: %s %s",
            $level,
            $this->correlationId,
            $message,
            json_encode($context)
        ));
    }
}

// Tracer ุจุฑุง ูพุฑููุงููฺฏ
class Tracer {
    private string $correlationId;
    private array $spans = [];
    
    public function __construct(string $correlationId) {
        $this->correlationId = $correlationId;
    }
    
    public function startSpan(string $name): Span {
        $span = new Span($name, microtime(true));
        $this->spans[$name] = $span;
        return $span;
    }
    
    public function finish(): void {
        foreach ($this->spans as $span) {
            $this->logger->debug('Span completed', [
                'span' => $span->name,
                'duration_ms' => $span->getDuration(),
                'correlation_id' => $this->correlationId
            ]);
        }
    }
}

// ฺฏุณุชุฑุด ุงูุฏูพููุช Health
public function health_check(): WP_REST_Response {
    $status = [
        'db' => $this->check_db(),
        'cache' => $this->check_cache(),
        'circuit_breaker' => $this->circuitBreaker->getStatus(),
        'dlq_count' => $this->dlq->getCount()
    ];
    return new WP_REST_Response($status);
}
```

**ุชุณุชโูุง ููุฑุฏ ูุงุฒ:**

| ูุงู ุชุณุช                          | ุณูุงุฑู                                               | ูพูุดุด        | ุงูุฒุงู             |
| -------------------------------- | ---------------------------------------------------- | ----------- | ----------------- |
| CorrelationIdPropagationTest     | ุงุฑุณุงู Correlation ID ุฏุฑ ฺูุฏ ุณุฑูุณ ู ุจุฑุฑุณ ุซุจุช ุฏุฑ ูุงฺฏ | Integration | โ                 |
| TracerSpanCompletionTest         | ุงุทููุงู ุงุฒ finish ุฏุฑ ูุณุฑูุง ุฎุทุง                     | Unit        | ุงุณุชูุงุฏู ุงุฒ Tracer |
| HealthIncludesCircuitBreakerTest | ุงูุฏูพููุช Health ูุถุนุช ูุฏุงุฑุดฺฉู ู DLQ ุฑุง ุจุฑูโฺฏุฑุฏุงูุฏ    | Integration | โ                 |
| HealthCircuitBreakerTest         | ููุช ูุฏุงุฑ ุจุงุฒ ุงุณุชุ ูพุงุณุฎ health ok=false              | Integration | ุดุจูโุณุงุฒ ุฎุทุง      |
| MetricsCircuitBreakerTest        | ฺฏุฒุงุฑุด status ูุฏุงุฑุดฺฉู                                 | Integration | ุงูุฏูพููุช ูุชุฑฺฉ    |

#### 3.5 ูุงู ฺฉุงุฑุจุฑุฏ - ExportService

**ุจุฑุฑุณ ุจุง ุณูุฏ ุงุฌุฑุง:**
ุฎุฑูุฌ ุงฺฉุณู ุจุงุฏ ุจุง ุงุณุชุฑู chunkโูุญูุฑุ ูุฑูุงูโุณุงุฒ ู Bulk Insert ฺฉุงูู ุจุงุดุฏ.

**ูุถุนุช ูุนู:**
*   ุชููุฏ ูุงู ุจูโุตูุฑุช ฺฉุงูู ุฏุฑ ุญุงูุธู ู ุนุฏู Bulk Insert ุฎุทุงูุง.
*   ููุงูู ูุฑูุงูโุณุงุฒ/ุงุนุชุจุงุฑุณูุฌ ุญุฏุงูู ูุณุชูุฏ.
*   ุนููุงุช ุฑู ุฏุงุฏูู ุฏุงุฎู ุญุงูุธู ุงูุฌุงู ูโุดูุฏ ู ุงุณุชุฑู ุงุณุชูุงุฏู ูุดุฏู ุงุณุช.

**ูุดฺฉูุงุช ุดูุงุณุงโุดุฏู:**
*   ูุตุฑู ุจุงูุง ุญุงูุธู ุจุฑุง ูุงูโูุง ุจุฒุฑฺฏ.
*   ุนุฏู ุงุณุชุฑู ู ุนุฏู ุงุณุชูุงุฏู ุงุฒ bulkInsertErrors ุจุง SQL ูุงุญุฏ.
*   ููุงูู ูุฑูุงูโุณุงุฒ/ุงุนุชุจุงุฑุณูุฌ ูุงูุต.

**ฺฉุฏูุง ูพุดููุงุฏ ุจุฑุง ููุดุชู:**

```php
private function writeXlsx(iterable $rows, string $file): void {
    $spreadsheet = new Spreadsheet();
    $sheet = $spreadsheet->getActiveSheet();
    $rowIdx = 1;
    
    foreach ($rows as $row) {
        foreach ($this->config->columns as $colIdx => $field) {
            $value = (string)($row[$field] ?? '');
            // ุญูุธ ุตูุฑูุง ูพุดุฑู
            $sheet->setCellValueExplicitByColumnAndRow(
                $colIdx + 1,
                $rowIdx,
                $value,
                DataType::TYPE_STRING
            );
        }
        $rowIdx++;
        
        // ูุฏุฑุช ุญุงูุธู ุจุฑุง ูุงูโูุง ุจุฒุฑฺฏ
        if ($rowIdx % 500 === 0) {
            $sheet->garbageCollect();
        }
    }
    
    // ุงุณุชูุงุฏู ุงุฒ Writer ุจู ุฌุง save ุจุฑุง ุงุณุชุฑู
    $writer = new Xlsx($spreadsheet);
    $writer->save($file);
    $spreadsheet->disconnectWorksheets();
    unset($spreadsheet);
}

// Bulk Insert ุจุฑุง ุฎุทุงูุง
public function bulkInsertErrors(int $logId, array $errors): void {
    if (!$errors) {
        return;
    }
    global $wpdb;
    $table = $wpdb->prefix . 'smartalloc_export_errors';
    $values = [];
    $params = [];
    foreach ($errors as $e) {
        $values[] = '(%d,%d,%d,%s,%s)';
        $params[] = $logId;
        $params[] = $e['form_id'] ?? 0;
        $params[] = $e['row'];
        $params[] = $e['column'];
        $params[] = $e['message'];
    }
    $sql = "INSERT INTO {$table} (export_id,form_id,row_index,column_name,message) VALUES " . implode(',', $values);
    // Use DbSafe::mustPrepare for all dynamic SQL
    $wpdb->query(DbSafe::mustPrepare($sql, $params));
}
```

**ุชุณุชโูุง ููุฑุฏ ูุงุฒ:**

| ูุงู ุชุณุช                    | ุณูุงุฑู                                | ูพูุดุด        | ุงูุฒุงู                  |
| -------------------------- | ------------------------------------- | ----------- | ---------------------- |
| ExportStreamMemoryTest     | ุฎุฑูุฌ ฑฐk ุฑฺฉูุฑุฏ ุจุง ูุตุฑู ุญุงูุธู < 128MB | Performance | p95 < 2s               |
| ExportLargeDatasetPerfTest | 1000 ุฑฺฉูุฑุฏุ p95<2s                    | Performance | ุงูุฒุงูุงุช ุนููฺฉุฑุฏ         |
| ExportNormalizationTest    | ุตูุฑูุง ูพุดุฑู ุญูุธ ุดููุฏ                 | Unit        | ููุงูู ูุฑูุงูโุณุงุฒ       |
| ExportValidationRulesTest  | ุฎุทุง Postal/City mismatch             | Unit        | ุฏุฑุฌ ุฎุทุง ุฏุฑ sheet Error |

#### 3.6 ูุงู ฺฉุงุฑุจุฑุฏ - CrosswalkService

**ุจุฑุฑุณ ุจุง ุณูุฏ ุงุฌุฑุง:**
ุจุงุฏ L1/L2 Cache ู ูฺฉุงูุฒู invalidation ฺฉุงูู ุฏุงุดุชู ุจุงุดุฏ.

**ูุถุนุช ูุนู:**
*   ููุท L1 cache ุจุฏูู ูฺฉุงูุฒู invalidation ุงุณุชูุงุฏู ูโุดูุฏ.
*   ฺฉุด L1 ุงุณุชูุงุฏู ูโุดูุฏ ูู invalidation ุชููุง ุจุง ุซุจุช ฺฉ ูุงฺฏ ุงูุฌุงู ูโุดูุฏ.

**ูุดฺฉูุงุช ุดูุงุณุงโุดุฏู:**
*   ูุจูุฏ invalidation ููฺฏุงู ุชุบุฑ ุฏุงุฏูโูุง.
*   ุนุฏู ุงุณุชูุงุฏู ุงุฒ L2 cache ุง TTL ูพูุง ูุฑุงุฑุฏุงุฏ.
*   ูุจูุฏ ูุณุฎูโุจูุฏ ฺฉุด ู invalidation ูุงูุน.

**ฺฉุฏูุง ูพุดููุงุฏ ุจุฑุง ููุดุชู:**

```php
class CrosswalkService {
    private const CACHE_GROUP = 'smartalloc_crosswalk';
    private const CACHE_VERSION_KEY = 'crosswalk_version';
    
    private $cache;
    private $db;
    
    public function __construct(CacheInterface $cache, DbInterface $db) {
        $this->cache = $cache;
        $this->db = $db;
    }
    
    public function getVersion(): int {
        $version = $this->cache->get(self::CACHE_VERSION_KEY, self::CACHE_GROUP);
        if ($version === false) {
            $version = (int)$this->db->get_var(
                "SELECT UNIX_TIMESTAMP(MAX(updated_at)) FROM {$this->db->prefix}smart_alloc_crosswalk"
            );
            $this->cache->set(self::CACHE_VERSION_KEY, $version, 0, self::CACHE_GROUP);
        }
        return $version;
    }
    
    private function versionedKey(string $baseKey): string {
        return $baseKey . ':v' . $this->getVersion();
    }
    
    public function getCrosswalkData(): array {
        $cacheKey = $this->versionedKey('crosswalk_data');
        $data = $this->cache->get($cacheKey, self::CACHE_GROUP);
        
        if ($data === false) {
            $data = $this->db->get_results(
                "SELECT * FROM {$this->db->prefix}smart_alloc_crosswalk",
                ARRAY_A
            );
            $this->cache->set($cacheKey, $data, HOUR_IN_SECONDS, self::CACHE_GROUP);
        }
        
        return $data;
    }
    
    public function invalidateCache(): void {
        $this->cache->set(
            self::CACHE_VERSION_KEY, 
            time(), 
            0, 
            self::CACHE_GROUP
        );
    }
}
```

**ุชุณุชโูุง ููุฑุฏ ูุงุฒ:**

| ูุงู ุชุณุช                        | ุณูุงุฑู                                                       | ูพูุดุด        | ุงูุฒุงู                |
| ------------------------------ | ------------------------------------------------------------ | ----------- | -------------------- |
| CrosswalkCacheVersioningTest   | ุชุบุฑ ุฏุงุฏูโูุง ู ุจุฑุฑุณ ูุณุฎูโุจูุฏ ฺฉุด                             | Unit        | invalidation ุตุญุญ    |
| CrosswalkL2CacheTest           | ุงุณุชูุงุฏู ุงุฒ Redis ุจู ุนููุงู L2 cache                           | Integration | ูพุดุชุจุงู ุงุฒ L2 cache |
| CrosswalkVersionBumpTest       | ูุฑุงุฎูุงู invalidate() ุจุงุฏ ูุณุฎู ฺฉุด ุฑุง ุงูุฒุงุด ุฏูุฏ             | Unit        | โ                    |
| CrosswalkCacheInvalidationTest | ูพุณ ุงุฒ invalidate()ุ ูุฑุงุฎูุงู schoolCodeByName ุจุงุฏ ุฏุงุฏูโูุง ุฑุง ุงุฒ DB ุจุงุฒุงุจ ฺฉูุฏ | Integration | โ                    |

### 4. ุงูููุชโุจูุฏ ฺฉู ุงูุฏุงูุงุช

| ุณุทุญ ุงูููุช | ุงูุฏุงู                                              | ุชุฎูู ุฒูุงู | ุชุฃุซุฑ | ุงูุฒุงู ุณูุฏ ุงุฌุฑุง         |
| ---------- | -------------------------------------------------- | ---------- | ----- | ------------------------ |
| ููุฑ       | ุชฺฉูู NotificationService (throttle + DLQ metrics) | 2 ุฑูุฒ      | ุจุงูุง  | ุงูุฒุงูุงุช ุงููุช ู ุนููฺฉุฑุฏ |
| ููุฑ       | ูพุงุฏูโุณุงุฒ typed CircuitBreaker                     | 1 ุฑูุฒ      | ุจุงูุง  | ุงูุฒุงูุงุช Observability    |
| ููุฑ       | ุฑูุน ุชุณุชโูุง ูุงูุต ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุฑฺฏุฑุณูู            | 1.5 ุฑูุฒ    | ุจุงูุง  | ุงูุฒุงูุงุช ฺฉูุช            |
| ููู        | ูพุดุชุจุงู AND/OR ุฏุฑ Rule Engine ู ุณุงุฎุชุงุฑ ููุทู      | 2 ุฑูุฒ      | ุจุงูุง  | ุงูุฒุงูุงุช ฺฉุณุจโูฺฉุงุฑ          |
| ููู        | ุงุณุชุฑู ู Bulk Insert ุฏุฑ ExportService              | 2 ุฑูุฒ      | ุจุงูุง  | ุงูุฒุงูุงุช ุนููฺฉุฑุฏ          |
| ููู        | ุงุถุงููโฺฉุฑุฏู Correlation ID ู Tracer ุฏุฑ Logging       | 1.5 ุฑูุฒ    | ูุชูุณุท | ุงูุฒุงูุงุช Observability    |
| ูุชูุณุท      | ูุณุฎูโฺฏุฐุงุฑ ู invalidation ุฏุฑ CrosswalkService       | 1 ุฑูุฒ      | ูุชูุณุท | ุงูุฒุงูุงุช ฺฉุด               |
| ูุชูุณุท      | ูพูุดุด ุชุณุช VIP/Performance                           | 1.5 ุฑูุฒ    | ูุชูุณุท | ุงูุฒุงูุงุช ุณุงุฒฺฏุงุฑ          |

### 5. ูุดุฏุงุฑูุง ุงููุช ุญุงุช

#### 5.1 ุฑุณฺฉโูุง ุงููุช ุงุตู

*   **ฺฉุฏ SQL ุฏุณุช:** ุงุณุชูุงุฏู ฺฏุณุชุฑุฏู ุงุฒ global `$wpdb` ุฏุฑ ุณุฑูุณโูุง (ูุซู ExportService ู CrosswalkService) ุฑุณฺฉ ุชุฒุฑู SQL ุฏุงุฑุฏุ ุงุทููุงู ุงุฒ `DbSafe::mustPrepare` ุฏุฑ ูููู ฺฉูุฆุฑโูุง ุถุฑูุฑ ุงุณุช.
*   **ุนุฏู ุงุนุชุจุงุฑุณูุฌ ฺฉุงูู ูุฑูุฏโูุง:** ุงูุฏูพููุชโูุง REST ูพุงุฑุงูุชุฑูุง ุฑุง ููุท ุจูโุตูุฑุช ุณุทุญ ุจุฑุฑุณ ูโฺฉููุฏุ ุจุงุฏ ุงุฒ `sanitize_text_field` ู `rest_validate_value_from_schema` ุจุฑุง ูููู ููุฏูุง ุงุณุชูุงุฏู ุดูุฏ.
*   **Rate limiting:** ุจุฏูู throttling ุฏุฑ NotificationServiceุ ุงูฺฉุงู ุญูููู DoS ุจู ุณุณุชู ุงุนูุงูุงุช ูุฌูุฏ ุฏุงุฑุฏ.
*   **ุฏุงุฏูโูุง ุญุณุงุณ ุฏุฑ ูุงฺฏ:** ุฏุฑ Logger ุจุงุฏ ุงุทููุงู ุญุงุตู ุดูุฏ ฺฉู Correlation ID ู context ูุงูุฏ ุงุทูุงุนุงุช ุญุณุงุณ (PII) ูุณุชูุฏุ `Redactor` ุจุงุฏ ูุจู ุงุฒ ุซุจุชุ ุฏุงุฏูโูุง ุฑุง ูุงุณฺฉ ฺฉูุฏ.
*   **Observability:** ูุจูุฏ ฺฏุฒุงุฑุด ูุฏุงุฑุดฺฉู ุฏุฑ health ุจุงุนุซ ูพููุงูโูุงูุฏู ุฎุทุงูุง ูพูุณุชู ูโุดูุฏ.
*   **Cache invalidation:** ุนุฏู ูุณุฎูโุจูุฏ Crosswalk ูโุชูุงูุฏ ุฏุงุฏูโูุง ูุฏู ุฑุง ุฏุฑ ุงุฎุชุงุฑ ฺฉุงุฑุจุฑุงู ูุฑุงุฑ ุฏูุฏ ฺฉู ุฑุณฺฉ logic bug ูุญุณูุจ ูโุดูุฏ.

#### 5.2 ุฑุงูฺฉุงุฑูุง ุงููุช ูพุดููุงุฏ

```php
// ุจุฑุฑุณ ู ูพุงุฑุงูุชุฑุณุงุฒ ฺฉูุฆุฑโูุง
public function safeQuery(string $sql, ...$params): mixed {
    $prepared = $this->db->prepare($sql, $params);
    return $this->db->query($prepared);
}

// ุงุนุชุจุงุฑุณูุฌ ูุฑูุฏโูุง REST
protected function validateRequest(array $request): array {
    $schema = [
        'type' => 'object',
        'properties' => [
            'student_id' => [
                'type' => 'integer',
                'minimum' => 1
            ],
            'mentor_id' => [
                'type' => 'integer',
                'minimum' => 1
            ]
        ],
        'required' => ['student_id', 'mentor_id']
    ];
    
    $valid = rest_validate_value_from_schema($request, $schema, 'request');
    if (is_wp_error($valid)) {
        throw new \Exception($valid->get_error_message());
    }
    
    return [
        'student_id' => (int)$request['student_id'],
        'mentor_id' => (int)$request['mentor_id']
    ];
}

// Redactor ุจุฑุง ูพุงฺฉโุณุงุฒ ุฏุงุฏูโูุง ุญุณุงุณ
class Redactor {
    private const SENSITIVE_FIELDS = [
        'national_id', 'phone', 'email', 'postal_code'
    ];
    
    public static function sanitize(array $data): array {
        foreach (self::SENSITIVE_FIELDS as $field) {
            if (isset($data[$field])) {
                $data[$field] = self::maskValue($data[$field]);
            }
        }
        return $data;
    }
    
    private static function maskValue(string $value): string {
        $length = strlen($value);
        if ($length <= 4) {
            return '****';
        }
        return substr($value, 0, 2) . '****' . substr($value, -2);
    }
}
```

### 6. ูพุดููุงุฏุงุช ููุง ู ุชูุตูโูุง

#### 6.1 ุงูุฒุงูุงุช ฺฉูุฏ ุจุฑุง ุงุฌุฑุง ูููู

*   **ุฑุนุงุช ุงุณุชุงูุฏุงุฑุฏูุง:** ุชูุงู ฺฉุฏูุง ูพุดููุงุฏ ุจุงุฏ ุจุง ุงุณุชุงูุฏุงุฑุฏูุง WordPress ู PSR-12 ุณุงุฒฺฏุงุฑ ุจุงุดูุฏ ู ุงุฒ `gmdate()` ุจุฑุง ุฒูุงู UTC ุงุณุชูุงุฏู ฺฉููุฏ.
*   **ูุงฺฏโฺฏุฑ ุณุงุฎุชุงุฑููุฏ:** ูุงฺฏโูุง ุจุงุฏ ุดุงูู correlation ู ูุชุฑฺฉโูุง ุจุง ูุงูโฺฏุฐุงุฑ ุณุงุฒฺฏุงุฑ (snake_case) ุจุงุดูุฏ.
*   **ุชุณุชโูุง ุฌุงูุน:** ุจุฑุง ูุฑ ุชุบุฑุ ุชุณุชโูุง Unit/Integration/Performance ูุทุงุจู ุฌุฏุงูู ุจุงูุง ุชูู ู ุงุฌุฑุง ุดููุฏ.
*   **ูุฑูุงูโุณุงุฒ ฺฉุงูู:** ููุงูู ูุฑูุงูโุณุงุฒ ู ุงุนุชุจุงุฑุณูุฌ ฺฉุงูู ุดููุฏ (ุจู ูฺู ุจุฑุง ููุฏูุง ุจุง ุตูุฑ ูพุดุฑู).
*   **ุจูููโุณุงุฒ ุญุงูุธู:** ExportService ุจุฑุง ูุงูโูุง ุจุฒุฑฺฏ ุจุง ุงุณุชูุงุฏู ุงุฒ ุงุณุชุฑู ู chunking ุจูููโุณุงุฒ ุดูุฏ.

#### 6.2 ฺฏุงูโูุง ุจุนุฏ ูพุดููุงุฏ

*   **ุชฺฉูู ุณุณุชู ุงุนูุงูุงุช:**
    *   ูพุงุฏูโุณุงุฒ ูฺฉุงูุฒู throttle ุจุฑ ุงุณุงุณ RateLimiter.
    *   ุงุฏุบุงู ฺฉุงูู ุจุง DLQ ู ูุชุฑฺฉโูุง.
    *   ูพุงุฏูโุณุงุฒ ุณุงุณุชโูุง ุงุฑุณุงู ูพุงุฑุงูุชุฑฺฉ.
*   **ุจูุจูุฏ ููุชูุฑ ููุงุนุฏ:**
    *   ูพุดุชุจุงู ุงุฒ ุดุฑุงุท ุชุฑฺฉุจ (AND/OR).
    *   ุงูุฒูุฏู ุณุงุฎุชุงุฑ ุฏุฑุฎุช ููุทู ุจู EvaluationResult.
    *   ุชฺฉูู ุชุณุชโูุง RuleEngineController.
*   **ุจูููโุณุงุฒ ุฎุฑูุฌโฺฏุฑ:**
    *   ูพุงุฏูโุณุงุฒ ุงุณุชุฑู ุจุฑุง ูุงูโูุง ุญุฌู.
    *   ุงูุฒูุฏู ููุงูู ูุฑูุงูโุณุงุฒ ู ุงุนุชุจุงุฑุณูุฌ ฺฉุงูู.
    *   ูพุงุฏูโุณุงุฒ Bulk Insert ุจุฑุง ุฎุทุงูุง.
*   **ุชฺฉูู Observability:**
    *   ุงูุฒูุฏู Correlation ID ุจู ุชูุงู ูุงฺฏโูุง.
    *   ูพุงุฏูโุณุงุฒ Tracer ุฏุฑ ุชูุงู ูุงูโูุง.
    *   ฺฏุณุชุฑุด ุงูุฏูพููุชโูุง Health/Metrics ุจุฑุง ฺฏุฒุงุฑุด ูุฏุงุฑุดฺฉู ู DLQ.

ุงู ุณูุฏ ููุง ุจุฑ ุงุณุงุณ ุชุญูู ุฏูู ุชูุงู ฺฏุฒุงุฑุดโูุง ุงุฑุณุงู ู ุณูุฏ ุงุฌุฑุง ูพุฑูฺู ุชูู ุดุฏู ู ููุดู ุฑุงู ุฌุงูุน ุจุฑุง ุชฺฉูู ูพุฑูฺู SmartAlloc ุงุฑุงุฆู ูโุฏูุฏ. ูพุฑู ุงุฒ ุงู ููุดู ุฑุงู ุชุถูู ูโฺฉูุฏ ฺฉู ูพุฑูฺู ุจู ุตูุฑุช ฺฉุงููุ ุงูู ู ูุทุงุจู ุจุง ุงูุฒุงูุงุช ุณูุฏ ุงุฌุฑุง (v2.0) ุชฺฉูู ุดูุฏ.

**Reference:** `PATCH_GUARD_STANDARDS_WordPress_2025-09-07.md` โ canonical rules, exceptions and tooling.