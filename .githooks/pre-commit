#!/usr/bin/env bash
# .githooks/pre-commit - run Docker precommit checks, then append project state

set -euo pipefail

echo "▶ Running SmartAlloc Docker pre-commit checks…"
if [ -x "scripts/precommit-docker.sh" ]; then
  ./scripts/precommit-docker.sh
else
  echo "❌ scripts/precommit-docker.sh not found or not executable" >&2
  exit 1
fi

# Append current state to project history (best-effort)
# check for last_state.yml
if [ ! -f "ai_outputs/last_state.yml" ]; then
    echo "ℹ️ ai_outputs/last_state.yml not found. Run status-auditor.sh to generate current state. Skipping state append."
    exit 0
fi

# ensure docs/PROJECT_STATE.yml exists
if [ ! -f "docs/PROJECT_STATE.yml" ]; then
    echo "INFO: Creating docs/PROJECT_STATE.yml"
    mkdir -p docs
    echo "# تاریخچهٔ انسانی پروژه SmartAlloc" > docs/PROJECT_STATE.yml
    echo "# هر ورودی با تاریخ و وضعیت پروژه در زمان commit ذخیره می‌شود" >> docs/PROJECT_STATE.yml
    echo "" >> docs/PROJECT_STATE.yml
fi

TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "N/A")
BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "N/A")

{
  echo ""
  echo "timestamp: \"$TIMESTAMP\""
  echo "commit: \"$COMMIT_HASH\""
  echo "branch: \"$BRANCH\""
  cat ai_outputs/last_state.yml
} >> docs/PROJECT_STATE.yml

echo "✅ وضعیت پروژه به docs/PROJECT_STATE.yml الحاق شد"
exit 0
