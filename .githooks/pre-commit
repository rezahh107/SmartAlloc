#!/usr/bin/env bash
# .githooks/pre-commit - run Docker precommit checks, then append project state

set -euo pipefail

echo "▶ Running SmartAlloc pre-commit checks…"

# Prefer Docker-based checks when available; otherwise fall back to local lightweight checks.
if [ -x "scripts/precommit-docker.sh" ] \
   && { docker compose version >/dev/null 2>&1 || command -v docker-compose >/dev/null 2>&1; } \
   && docker info >/dev/null 2>&1; then
  ./scripts/precommit-docker.sh
else
  echo "ℹ️ Docker not available. Using local fallback (selective quality + baseline + patch guard)"
  # Ensure Composer deps exist (best-effort, non-fatal if composer missing)
  if [ ! -x vendor/bin/phpcs ] || [ ! -x vendor/bin/phpstan ]; then
    if command -v composer >/dev/null 2>&1; then
      COMPOSER_MEMORY_LIMIT=-1 composer install -o || true
    fi
  fi
  # Minimal gates (blocking)
  if command -v composer >/dev/null 2>&1; then
    composer run -q quality:selective
  else
    echo "❌ composer not found; cannot run selective quality" >&2
    exit 1
  fi
  php baseline-check --current-phase=FOUNDATION
  bash scripts/patch-guard-check.sh
fi

# Append current state to project history (best-effort)
# check for last_state.yml
if [ ! -f "ai_outputs/last_state.yml" ]; then
    echo "ℹ️ ai_outputs/last_state.yml not found. Run status-auditor.sh to generate current state. Skipping state append."
    exit 0
fi

# ensure docs/PROJECT_STATE.yml exists
if [ ! -f "docs/PROJECT_STATE.yml" ]; then
    echo "INFO: Creating docs/PROJECT_STATE.yml"
    mkdir -p docs
    echo "# تاریخچهٔ انسانی پروژه SmartAlloc" > docs/PROJECT_STATE.yml
    echo "# هر ورودی با تاریخ و وضعیت پروژه در زمان commit ذخیره می‌شود" >> docs/PROJECT_STATE.yml
    echo "" >> docs/PROJECT_STATE.yml
fi

TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "N/A")
BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "N/A")

{
  echo ""
  echo "timestamp: \"$TIMESTAMP\""
  echo "commit: \"$COMMIT_HASH\""
  echo "branch: \"$BRANCH\""
  cat ai_outputs/last_state.yml
} >> docs/PROJECT_STATE.yml

echo "✅ وضعیت پروژه به docs/PROJECT_STATE.yml الحاق شد"
exit 0
