#!/usr/bin/env bash
# .githooks/pre-push - run Docker pre-push checks

set -euo pipefail

echo "▶ Running SmartAlloc pre-push checks…"
if [ -x "scripts/prepush-docker.sh" ] \
   && { docker compose version >/dev/null 2>&1 || command -v docker-compose >/dev/null 2>&1; } \
   && docker info >/dev/null 2>&1; then
  ./scripts/prepush-docker.sh
else
  echo "ℹ️ Docker not available. Using local fallback (tests + patch guard)"
  # Ensure Composer deps (best-effort)
  if [ ! -x vendor/bin/phpunit ]; then
    if command -v composer >/dev/null 2>&1; then
      COMPOSER_MEMORY_LIMIT=-1 composer install -o || true
    fi
  fi
  # Run tests (non-blocking like docker variant for broader suites)
  if command -v composer >/dev/null 2>&1; then
    echo " - unit (fast)" && composer -q test:debug || echo "   ⚠ unit failed (non-blocking)"
    echo " - integration" && composer -q test:integration || echo "   ⚠ integration failed (non-blocking)"
    echo " - foundation" && composer -q test:foundation || echo "   ⚠ foundation failed (non-blocking)"
  fi
  # E2E guard based on changed files (non-blocking)
  if [ -x scripts/e2e-change-guard.sh ]; then
    bash scripts/e2e-change-guard.sh || true
  fi
  # Optional QA orchestration (non-blocking)
  if [ -x scripts/qa-orchestrator.sh ]; then
    bash scripts/qa-orchestrator.sh || true
  fi
  # Patch Guard (blocking)
  bash scripts/patch-guard-check.sh
fi

exit 0
