#!/usr/bin/env bash
set -euo pipefail

PHP_VERSION="${1:-8.2}"
WP_VERSION="${2:-latest}"

echo "# ðŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù¾Ø±ÙˆÚ˜Ù‡ SmartAlloc" > PROJECT_STATE.md
echo "**Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ**: $(date -u '+%Y-%m-%d %H:%M UTC')" >> PROJECT_STATE.md
echo "**Ø´Ø§Ø®Ù‡**: $(git branch --show-current 2>/dev/null || echo unknown)" >> PROJECT_STATE.md
echo "**Ú©Ø§Ù…ÛŒØª**: $(git log -1 --pretty='%h %s' 2>/dev/null || echo none)" >> PROJECT_STATE.md
echo "**PHP**: $PHP_VERSION | **ÙˆØ±Ø¯Ù¾Ø±Ø³**: $WP_VERSION" >> PROJECT_STATE.md

echo -e "\n## ðŸŽ¯ ÙˆØ¶Ø¹ÛŒØª Ú©Ù„ÛŒ" >> PROJECT_STATE.md
if [ -f coverage.xml ]; then
  COV=$(grep -o 'lines percent="[0-9.]*"' coverage.xml | head -1 | sed 's/[^0-9.]*//g')
  echo "- **Ù¾ÙˆØ´Ø´ ØªØ³Øª**: ${COV}%" >> PROJECT_STATE.md
else
  echo "- **Ù¾ÙˆØ´Ø´ ØªØ³Øª**: Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯" >> PROJECT_STATE.md
fi

echo -e "\n## ðŸ”’ ÙˆØ¶Ø¹ÛŒØª Ø§Ù…Ù†ÛŒØªÛŒ" >> PROJECT_STATE.md
if ls psalm*.xml >/dev/null 2>&1; then
  ERR=$(grep -ci "error" psalm*.xml || true)
  echo "- Ø®Ø·Ø§Ù‡Ø§ÛŒ Psalm: ${ERR}" >> PROJECT_STATE.md
else
  echo "- Ú¯Ø²Ø§Ø±Ø´ Psalm Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯" >> PROJECT_STATE.md
fi

echo -e "\n## ðŸ“‹ ÙˆØ¶Ø¹ÛŒØª Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ" >> PROJECT_STATE.md
echo "| ÙˆÛŒÚ˜Ú¯ÛŒ | ÙˆØ¶Ø¹ÛŒØª | ØªØ³Øª | Ø§Ù…Ù†ÛŒØª |" >> PROJECT_STATE.md
echo "|---|---|---|---|" >> PROJECT_STATE.md
for F in "Allocator|src/Services/AllocationService.php|tests/Unit/AllocatorTest.php" \
         "RBAC|src/Http/RestController.php|tests/VIP/SecurityAuditTest.php" \
         "Export|src/Services/ExportService.php|tests/Integration/ExportTest.php" \
         "Events|src/Event/EventBus.php|tests/Unit/EventBusTest.php"
do
  IFS='|' read -r NAME PATH TEST <<< "$F"
  S=$([ -e "$PATH" ] && echo "âœ…" || echo "âšª")
  T=$([ -e "$TEST" ] && echo "âœ…" || echo "âš ï¸")
  echo "| $NAME | $S | $T | TBD |" >> PROJECT_STATE.md
done

echo -e "\n## ðŸ”„ Ø¢Ø®Ø±ÛŒÙ† ØªØºÛŒÛŒØ±Ø§Øª" >> PROJECT_STATE.md
git log -5 --pretty="- %h %s (%ad)" --date=short >> PROJECT_STATE.md || true

php scripts/generate_features_md.php || true
php scripts/ai_context_sync.php || true

echo -e "\n## ðŸ“Œ Features Snapshot" >> PROJECT_STATE.md
if [ -f "FEATURES.md" ]; then
  head -n 15 FEATURES.md >> PROJECT_STATE.md
else
  echo "FEATURES.md not available" >> PROJECT_STATE.md
fi

echo -e "\n---\n*Generated by CI*" >> PROJECT_STATE.md
