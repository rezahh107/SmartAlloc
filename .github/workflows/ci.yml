name: SmartAlloc CI
on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'tests/**'
      - '.github/workflows/**'
      - 'composer.*'
      - 'phpcs.xml'
      - 'psalm.xml*'
      - 'phpunit.xml'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'tests/**'
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * 0'

permissions:
  contents: read
  pull-requests: write
  issues: write
  security-events: write

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  qa:
    name: ðŸ›¡ï¸ QA (PHP ${{ matrix.php }} / WP ${{ matrix.wp }})
    runs-on: ubuntu-latest
    timeout-minutes: 25
    services:
      mysql:
        image: mysql:8
        env:
          MYSQL_DATABASE: wordpress_test
          MYSQL_ALLOW_EMPTY_PASSWORD: "yes"
        ports: ['3306:3306']
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 --silent"
          --health-interval=10s --health-timeout=5s --health-retries=3
    strategy:
      fail-fast: false
      matrix:
        php: ['8.1', '8.2']
        wp: ['6.3', '6.4', 'latest']
        include:
          - php: '8.2'
            wp: 'latest'
            coverage: true

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: ðŸ› ï¸ System tools
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip zip subversion curl tar mysql-client

      - name: ðŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: mbstring, xml, json, mysqli, curl, dom
          tools: composer, phpunit
          coverage: xdebug

      - name: ðŸ—„ï¸ Cache Composer
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache/files
          key: composer-${{ runner.os }}-${{ hashFiles('**/composer.lock') }}
          restore-keys: composer-${{ runner.os }}-

      - name: ðŸ“¦ Composer install
        run: composer install --no-interaction --prefer-dist --ansi

      - name: ðŸ”§ PHPCS installed_paths (safety)
        run: |
          vendor/bin/phpcs --config-set installed_paths \
          vendor/automattic/vipwpcs,vendor/wp-coding-standards/wpcs, \
          vendor/phpcompatibility/php-compatibility, \
          vendor/phpcsstandards/phpcsextra, \
          vendor/phpcsstandards/phpcsutils

      - name: ðŸ§ª Install WP test suite
        env: { WP_VERSION: ${{ matrix.wp }} }
        run: |
          chmod +x scripts/install-wp-tests.sh
          bash scripts/install-wp-tests.sh wordpress_test root '' 127.0.0.1:3306 $WP_VERSION

      - name: ðŸ” PHPCS (soft-fail)
        run: vendor/bin/phpcs -q --standard=phpcs.xml --report=full --report-summary || true

      - name: ðŸ”Ž Psalm (soft-fail)
        run: |
          vendor/bin/psalm --no-progress --output-format=github --stats || true
          vendor/bin/psalm --taint-analysis || true

      - name: ðŸ§ª PHPUnit
        env: { XDEBUG_MODE: coverage }
        run: |
          vendor/bin/phpunit --testsuite Unit,WordPress,VIP,Integration \
            $([ "${{ matrix.coverage }}" == "true" ] && echo "--coverage-clover coverage.xml" || true)

      - name: ðŸ“Š Summary
        if: always()
        run: |
          echo "## SmartAlloc QA Summary" >> $GITHUB_STEP_SUMMARY
          echo "- PHP: ${{ matrix.php }} / WP: ${{ matrix.wp }}" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage.xml ]; then
            PCT=$(grep -o 'lines percent="[0-9.]*"' coverage.xml | head -1 | sed 's/[^0-9.]*//g')
            echo "- Coverage: ${PCT}%" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“¦ Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-${{ matrix.php }}-${{ matrix.wp }}
          path: |
            coverage.xml
            test-results.xml
            psalm*.xml
          retention-days: 14
