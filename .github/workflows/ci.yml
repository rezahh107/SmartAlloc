name: SmartAlloc CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  qa:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8
        env:
          MYSQL_DATABASE: wordpress_test
          MYSQL_ALLOW_EMPTY_PASSWORD: "yes"
        ports: ['3306:3306']
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 --silent"
          --health-interval=10s --health-timeout=5s --health-retries=3

    strategy:
      matrix:
        php: ['8.1']
        wp: ['latest']
        coverage: ['true']

    steps:
      - uses: actions/checkout@v4

      - name: 🐘 Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          tools: composer

      - name: 🛠️ System tools
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip zip subversion curl tar mysql-client

      - name: 📦 Install dependencies
        run: composer install --no-interaction --prefer-dist --ansi

      - name: 🔧 PHPCS installed_paths
        run: |
          vendor/bin/phpcs --config-set installed_paths \
          vendor/automattic/vipwpcs,vendor/wp-coding-standards/wpcs, \
          vendor/phpcompatibility/php-compatibility, \
          vendor/phpcompatibility/phpcompatibility-wp, \
          vendor/phpcsstandards/phpcsextra, \
          vendor/phpcsstandards/phpcsutils, \
          vendor/sirbrillig/phpcs-variable-analysis

      - name: 🧪 Install WP test suite
        env:
          WP_VERSION: ${{ matrix.wp }}
        run: |
          chmod +x scripts/install-wp-tests.sh
          bash scripts/install-wp-tests.sh wordpress_test root '' 127.0.0.1:3306 $WP_VERSION

      - name: 🔍 PHPCS (soft-fail)
        run: vendor/bin/phpcs -q --standard=phpcs.xml --report=full --report-summary || true

      - name: 🔎 Psalm (soft-fail)
        run: |
          vendor/bin/psalm --no-progress --output-format=github --stats || true
          vendor/bin/psalm --taint-analysis || true

      - name: 🧪 PHPUnit
        env:
          XDEBUG_MODE: coverage
        run: |
          SUITES="--testsuite Unit,WordPress,VIP,Integration"
          COVER=$([ "${{ matrix.coverage }}" == "true" ] && echo "--coverage-clover coverage.xml" || true)
          vendor/bin/phpunit $SUITES $COVER
