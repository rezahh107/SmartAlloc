name: SmartAlloc CI
on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'tests/**'
      - '.github/workflows/**'
      - 'composer.*'
      - 'phpcs.xml'
      - 'psalm.xml*'
      - 'phpunit.xml'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'tests/**'
  workflow_dispatch:
    inputs:
      inject_ci_failure:
        description: "Inject dummy ci_failure for AUTO-FIX test"
        type: boolean
        default: false
  schedule:
    - cron: '0 6 * * 0'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
permissions:
  contents: write
  actions: write

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  TZ: UTC

jobs:
  qa:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php: ['8.1','8.2']
    steps:
      - uses: actions/checkout@v5
      - name: ðŸ“¦ Install jq & bc (early)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc
      - name: ðŸ”§ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          coverage: none
      - name: ðŸ—ƒï¸ Composer cache (PHP-scoped)
        uses: actions/cache@v4
        with:
          path: ~/.cache/composer/files
          key: ${{ runner.os }}-php-${{ matrix.php }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-${{ matrix.php }}-composer-
      - name: ðŸ§± Ensure ai_context.json exists (pre)
        if: always()
        run: |
          set -euo pipefail
          test -s ai_context.json || echo '{"decisions":[]}' > ai_context.json
          jq empty ai_context.json
      - name: ðŸ”„ Sync AI context features
        run: php scripts/sync-features-to-ai-context.php
      - name: ðŸ“¥ Install dependencies
        run: composer install --no-interaction --prefer-dist --no-progress
      - name: Install Playwright deps
        run: npx playwright install --with-deps
      - name: ðŸŽ¨ PHPCBF (soft)
        run: composer phpcbf || true
      - name: ðŸ“Š 5D Score
        run: composer score:5d
      - name: âœ… Evaluate 5D gates
        if: always()
        run: |
          chmod +x scripts/evaluate_scores.sh
          scripts/evaluate_scores.sh
      - name: CI 5D Gates
        run: bash scripts/ci/ensure_ci_thresholds.sh
      - name: ðŸ”„ Update project state
        run: make state
      - name: ðŸš€ Commit state files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add FEATURES.md PROJECT_STATE.md ai_context.json
          git commit -m "chore: auto-update state files" || echo "no changes to commit"
          git push origin HEAD:${{ github.ref_name }} || true
      - name: ðŸ“ Append 5D Summary & AUTO-FIX
        if: always()
        run: |
          chmod +x .github/scripts/emit_summary.sh .github/scripts/emit_autofix.sh
          if [ "${{ inputs.inject_ci_failure }}" = "true" ]; then
            echo '{"ci_failure":{"security_score":15,"phpcs_errors":2,"test_failures":1}}' > ai_context.json
          fi
          .github/scripts/emit_summary.sh && .github/scripts/emit_autofix.sh
      - name: ðŸ“¤ Upload Enhanced Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: project-state-enhanced-${{ github.job }}-php${{ matrix.php }}-${{ github.run_id }}-${{ github.run_attempt }}
          if-no-files-found: warn
          path: |
            FEATURES.md
            ai_context.json
  full:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: ðŸ“¦ Install jq & bc (early)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc
      - name: ðŸ”§ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          coverage: none
      - name: ðŸ—ƒï¸ Composer cache (PHP-scoped)
        uses: actions/cache@v4
        with:
          path: ~/.cache/composer/files
          key: ${{ runner.os }}-php-8.2-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-8.2-composer-
      - name: ðŸ§± Ensure ai_context.json exists (pre)
        if: always()
        run: |
          set -euo pipefail
          test -s ai_context.json || echo '{"decisions":[]}' > ai_context.json
          jq empty ai_context.json
      - name: ðŸ”„ Sync AI context features
        run: php scripts/sync-features-to-ai-context.php
      - name: ðŸ“¥ Install dependencies
        run: composer install --no-interaction --prefer-dist --no-progress
      - name: Install Playwright deps
        run: npx playwright install --with-deps
      - name: ðŸŽ¨ PHPCBF (soft)
        run: composer phpcbf || true
      - name: ðŸ“Š 5D Score
        run: composer score:5d
      - name: âœ… Evaluate 5D gates
        if: always()
        run: |
          chmod +x scripts/evaluate_scores.sh
          scripts/evaluate_scores.sh
      - name: CI 5D Gates
        run: bash scripts/ci/ensure_ci_thresholds.sh
      - name: ðŸ”„ Update project state
        run: make state
      - name: ðŸš€ Commit state files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add FEATURES.md PROJECT_STATE.md ai_context.json
          git commit -m "chore: auto-update state files" || echo "no changes to commit"
          git push origin HEAD:${{ github.ref_name }} || true
      - name: ðŸ“ Append 5D Summary & AUTO-FIX
        if: always()
        run: |
          chmod +x .github/scripts/emit_summary.sh .github/scripts/emit_autofix.sh
          if [ "${{ inputs.inject_ci_failure }}" = "true" ]; then
            echo '{"ci_failure":{"security_score":15,"phpcs_errors":2,"test_failures":1}}' > ai_context.json
          fi
          .github/scripts/emit_summary.sh && .github/scripts/emit_autofix.sh
      - name: âŒ Enforce 5D gates (full only)
        if: always()
        run: |
          chmod +x scripts/fail_on_ci_failure.sh
          scripts/fail_on_ci_failure.sh
      - name: ðŸ“¤ Upload Enhanced Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: project-state-enhanced-${{ github.job }}-${{ github.run_id }}-${{ github.run_attempt }}
          if-no-files-found: warn
          path: |
            FEATURES.md
            ai_context.json

  phase-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Install yq
        run: |
          wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x /usr/local/bin/yq

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Sync AI context features
        run: |
          php scripts/sync-features-to-ai-context.php

      - name: Check Phase Transition Readiness
        run: |
          ./scripts/check_phase_transition.sh
        continue-on-error: true

      - name: Generate Transition Report
        if: always()
        run: |
          ./scripts/generate_phase_report.sh > phase_report.md

      - name: Upload Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: phase-transition-report
          path: phase_report.md
