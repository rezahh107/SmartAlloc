name: SmartAlloc CI
on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'tests/**'
      - '.github/workflows/**'
      - 'composer.*'
      - 'phpcs.xml'
      - 'psalm.xml*'
      - 'phpunit.xml'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'tests/**'
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * 0'

permissions:
  contents: read
  pull-requests: write
  issues: write
  security-events: write

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  qa:
    name: 🛡️ QA (PHP ${{ matrix.php }} / WP ${{ matrix.wp }})
    runs-on: ubuntu-latest
    timeout-minutes: 25
    services:
      mysql:
        image: mysql:8
        env:
          MYSQL_DATABASE: wordpress_test
          MYSQL_ALLOW_EMPTY_PASSWORD: "yes"
        ports: ['3306:3306']
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 --silent"
          --health-interval=10s --health-timeout=5s --health-retries=3
    strategy:
      fail-fast: false
      matrix:
        php: ['8.1', '8.2']
        wp: ['6.3', '6.4', 'latest']
        include:
          - php: '8.2'
            wp: 'latest'
            coverage: true

    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: 🛠️ System tools
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip zip subversion curl tar mysql-client jq

      - name: 🐘 Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: mbstring, xml, json, mysqli, curl, dom
          tools: composer, phpunit
          coverage: xdebug

      - name: 🗄️ Cache Composer
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache/files
          key: composer-${{ runner.os }}-${{ hashFiles('**/composer.lock') }}
          restore-keys: composer-${{ runner.os }}-

      - name: 📦 Composer install
        run: composer install --no-interaction --prefer-dist --ansi

      - name: 🔧 PHPCS installed_paths (safety)
        run: |
          vendor/bin/phpcs --config-set installed_paths \
          vendor/automattic/vipwpcs,vendor/wp-coding-standards/wpcs, \
          vendor/phpcompatibility/php-compatibility, \
          vendor/phpcompatibility/phpcompatibility-wp, \
          vendor/phpcsstandards/phpcsextra, \
          vendor/phpcsstandards/phpcsutils, \
          vendor/sirbrillig/phpcs-variable-analysis

      - name: 🧪 Install WP test suite
        env: { WP_VERSION: ${{ matrix.wp }} }
        run: |
          chmod +x scripts/install-wp-tests.sh
          bash scripts/install-wp-tests.sh wordpress_test root '' 127.0.0.1:3306 $WP_VERSION

      - name: 🔍 PHPCS (soft-fail)
        run: vendor/bin/phpcs -q --standard=phpcs.xml --report=full --report-summary || true

      - name: 🔎 Psalm (soft-fail)
        run: |
          vendor/bin/psalm --no-progress --output-format=github --stats || true
          vendor/bin/psalm --taint-analysis || true

      - name: 🧪 PHPUnit (smoke only, temporary)
        env:
          XDEBUG_MODE: coverage
        run: |
          vendor/bin/phpunit \
            tests/Unit/BrainMonkeySmokeTest.php \
            tests/WordPress/Smoke/BootTest.php

      - name: 🔄 Generate FEATURES.md
        if: always()
        run: php scripts/generate_features_md.php

      - name: 🔁 Sync AI context (ADRs → ai_context.json)
        if: always()
        run: php scripts/ai_context_sync.php

      - name: 📝 Append project state to summary
        if: always()
        run: |
          echo "## 📊 Feature Scores" >> $GITHUB_STEP_SUMMARY
          head -n 40 FEATURES.md >> $GITHUB_STEP_SUMMARY || true
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## 🤖 AI Context (decisions)" >> $GITHUB_STEP_SUMMARY
          cat ai_context.json | jq '.decisions | {count: length, items: .[0:5]}' >> $GITHUB_STEP_SUMMARY || true

      - name: 📦 Upload artifacts (state)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: state-artifacts
          path: |
            FEATURES.md
            ai_context.json
          retention-days: 14

      - name: 📊 Summary
        if: always()
        run: |
          echo "## SmartAlloc QA Summary" >> $GITHUB_STEP_SUMMARY
          echo "- PHP: ${{ matrix.php }} / WP: ${{ matrix.wp }}" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage.xml ]; then
            PCT=$(grep -o 'lines percent="[0-9.]*"' coverage.xml | head -1 | sed 's/[^0-9.]*//g')
            echo "- Coverage: ${PCT}%" >> $GITHUB_STEP_SUMMARY
          fi

      - name: 📦 Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-${{ matrix.php }}-${{ matrix.wp }}
          path: |
            coverage.xml
            test-results.xml
            psalm*.xml
          retention-days: 14

  full:
    name: 🔬 Full Test Matrix (manual/scheduled)
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    needs: qa
    services:
      mysql:
        image: mysql:8
        env:
          MYSQL_DATABASE: wordpress_test
          MYSQL_ALLOW_EMPTY_PASSWORD: "yes"
        ports: ['3306:3306']
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 --silent"
          --health-interval=10s --health-timeout=5s --health-retries=3
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with: { php-version: '8.1', tools: composer }
      - name: 🛠️ System tools
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip zip subversion curl tar mysql-client jq
      - run: composer install --no-interaction --prefer-dist --ansi
      - name: 🔧 PHPCS installed_paths (safety)
        run: |
          vendor/bin/phpcs --config-set installed_paths \
          vendor/automattic/vipwpcs,vendor/wp-coding-standards/wpcs, \
          vendor/phpcompatibility/php-compatibility, \
          vendor/phpcompatibility/phpcompatibility-wp, \
          vendor/phpcsstandards/phpcsextra, \
          vendor/phpcsstandards/phpcsutils, \
          vendor/sirbrillig/phpcs-variable-analysis
      - name: 🧪 Install WP test suite
        run: |
          chmod +x scripts/install-wp-tests.sh
          bash scripts/install-wp-tests.sh wordpress_test root '' 127.0.0.1:3306 latest
      - name: 🔍 PHPCS (soft-fail)
        run: vendor/bin/phpcs -q --standard=phpcs.xml --report=full --report-summary || true
      - name: 🔎 Psalm (soft-fail)
        run: |
          vendor/bin/psalm --no-progress --output-format=github --stats || true
          vendor/bin/psalm --taint-analysis || true
      - name: 🧪 PHPUnit (full suites)
        env: { XDEBUG_MODE: coverage }
        run: vendor/bin/phpunit --testsuite Unit,WordPress,VIP,Integration --coverage-clover coverage.xml
